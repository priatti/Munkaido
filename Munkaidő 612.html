<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Munkaidő Nyilvántartó Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        *,::before,::after{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::before,::after{--tw-content:''}html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}h1,h2,h3,h4,p,button,input,select,label{margin:0}h1,h2,h3,h4{font-size:inherit;font-weight:inherit}button,select{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;color:inherit;padding:0;text-transform:none}button,label{cursor:pointer}button{background-color:transparent;background-image:none}button:focus-visible{outline:2px solid transparent;outline-offset:2px}button:-moz-focusring{outline:auto}select{padding:0.5rem 2.5rem 0.5rem 0.75rem;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");background-position:right .5rem center;background-repeat:no-repeat;background-size:1.5em 1.5em}input,button,select{-webkit-appearance:none;-moz-appearance:none;appearance:none}input:not([type=button]):not([type=reset]):not([type=submit]){border-radius:0}input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{height:auto}input[type=search]{-webkit-appearance:textfield;outline-offset:-2px}input[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}svg,canvas{display:block;vertical-align:middle}
        .tab{flex:1 1 0%;padding:.75rem 1rem;text-align:center;font-size:.75rem;color:#4b5563;border-bottom-width:2px;border-color:transparent}@media (min-width: 600px){.tab{font-size:.875rem}}.tab-active{font-weight:600;color:#2563eb;background-color:#fff;border-color:#2563eb}.btn-primary{background-color:#3b82f6;color:#fff;padding:.5rem 1rem;border-radius:.5rem}.btn-primary:hover{background-color:#2563eb}.btn-secondary{background-color:#6b7280;color:#fff;padding:.5rem 1rem;border-radius:.5rem}.btn-secondary:hover{background-color:#4b5563}.input-group{display:flex;align-items:center;gap:.5rem}.dropdown-content{position:absolute;right:0;margin-top:.5rem;width:16rem;background-color:#f3f4f6;border-radius:.5rem;padding:.5rem;z-index:20;--tw-shadow:0 20px 25px -5px #0000001a, 0 8px 10px -6px #0000001a;--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color), 0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.dropdown-item{display:flex;align-items:center;width:100%;border-radius:.5rem;border:1px solid #e5e7eb;background-color:#fff;padding:.75rem;text-align:left;transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s;--tw-shadow:0 1px 2px 0 #0000000d;--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.dropdown-item:not(:last-child){margin-bottom:.5rem}.dropdown-item:hover{--tw-scale-x:1.02;--tw-scale-y:1.02;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));border-color:#60a5fa;--tw-shadow:0 10px 15px -3px #0000001a, 0 4px 6px -4px #0000001a;--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.dropdown-item-icon{margin-right:1rem;font-size:1.25rem;color:#3b82f6}.dropdown-item-title{font-size:1rem;font-weight:600;color:#1f2937}.dropdown-item-desc{font-size:.75rem;color:#6b7280}
        .fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.inset-0{top:0;right:0;bottom:0;left:0}.z-10{z-index:10}.z-20{z-index:20}.z-50{z-index:50}.mx-auto{margin-left:auto;margin-right:auto}.mx-4{margin-left:1rem;margin-right:1rem}.mb-1{margin-bottom:.25rem}.mb-2{margin-bottom:.5rem}.mb-3{margin-bottom:.75rem}.mb-4{margin-bottom:1rem}.mb-5{margin-bottom:1.25rem}.mb-6{margin-bottom:1.5rem}.mt-1{margin-top:.25rem}.mt-2{margin-top:.5rem}.mt-3{margin-top:.75rem}.mt-4{margin-top:1rem}.mt-6{margin-top:1.5rem}.mr-4{margin-right:1rem}.block{display:block}.flex{display:flex}.grid{display:grid}.hidden{display:none}.h-6{height:1.5rem}.h-10{height:2.5rem}.h-16{height:4rem}.min-h-screen{min-height:100vh}.w-6{width:1.5rem}.w-1\/2{width:50%}.w-2\/3{width:66.666667%}.w-11\/12{width:91.666667%}.w-16{height:4rem}.w-full{width:100%}.max-w-md{max-width:28rem}.max-w-sm{max-width:24rem}.flex-1{flex:1 1 0%}.scale-\[1\.02\]{--tw-scale-x:1.02;--tw-scale-y:1.02}.scale-95{--tw-scale-x:.95;--tw-scale-y:.95}.transform{transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.grid-cols-1{grid-template-columns:repeat(1, minmax(0, 1fr))}.grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.grid-cols-3{grid-template-columns:repeat(3, minmax(0, 1fr))}.grid-cols-\[1fr_auto_1fr_auto\]{grid-template-columns:1fr auto 1fr auto}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-x-3{column-gap:.75rem}.gap-2{gap:.5rem}.gap-3{gap:.75rem}.gap-4{gap:1rem}.space-y-1>*{margin-top:.25rem}.space-y-2>*{margin-top:.5rem}.space-y-3>*{margin-top:.75rem}.space-y-4>*{margin-top:1rem}.space-y-6>*{margin-top:1.5rem}.rounded{border-radius:.25rem}.rounded-md{border-radius:.375rem}.rounded-lg{border-radius:.5rem}.rounded-l{border-top-left-radius:.25rem;border-bottom-left-radius:.25rem}.rounded-r{border-top-right-radius:.25rem;border-bottom-right-radius:.25rem}.rounded-xl{border-radius:.75rem}.rounded-full{border-radius:9999px}.border{border-width:1px}.border-t{border-top-width:1px}.border-b-2{border-bottom-width:2px}.border-l-4{border-left-width:4px}.border-blue-200{border-color:#bfdbfe}.border-blue-400{border-color:#60a5fa}.border-blue-500{border-color:#3b82f6}.border-blue-800{border-color:#1e40af}.border-green-200{border-color:#bbf7d0}.border-green-500{border-color:#22c55e}.border-green-700{border-color:#15803d}.border-indigo-200{border-color:#c7d2fe}.border-indigo-300{border-color:#a5b4fc}.border-orange-200{border-color:#fed7aa}.border-orange-400{border-color:#fb923c}.border-orange-800{border-color:#9a3412}.border-gray-100{border-color:#f3f4f6}.border-gray-200{border-color:#e5e7eb}.border-gray-300{border-color:#d1d5db}.border-red-200{border-color:#fecaca}.border-red-500{border-color:#ef4444}.border-yellow-200{border-color:#fef08a}.border-yellow-400{border-color:#facc15}.bg-black{background-color:#000}.bg-white{background-color:#fff}.bg-gray-50{background-color:#f9fafb}.bg-gray-100{background-color:#f3f4f6}.bg-gray-200{background-color:#e5e7eb}.bg-gray-300{background-color:#d1d5db}.bg-blue-50{background-color:#eff6ff}.bg-blue-100{background-color:#dbeafe}.bg-blue-400{background-color:#60a5fa}.bg-blue-500{background-color:#3b82f6}.bg-blue-600{background-color:#2563eb}.bg-green-50{background-color:#f0fdf4}.bg-green-100{background-color:#dcfce7}.bg-green-200{background-color:#bbf7d0}.bg-green-500{background-color:#22c55e}.bg-green-700{background-color:#15803d}.bg-indigo-50{background-color:#eef2ff}.bg-indigo-100{background-color:#e0e7ff}.bg-indigo-200{background-color:#e0e7ff}.bg-indigo-400{background-color:#818cf8}.bg-indigo-500{background-color:#6366f1}.bg-orange-50{background-color:#fff7ed}.bg-orange-400{background-color:#fb923c}.bg-red-50{background-color:#fef2f2}.bg-red-500{background-color:#ef4444}.bg-yellow-100{background-color:#fef9c3}.bg-yellow-200{background-color:#fef08a}.bg-yellow-400{background-color:#facc15}.bg-opacity-60{--tw-bg-opacity:0.6;background-color:rgb(0 0 0 / var(--tw-bg-opacity))}.bg-gradient-to-r{background-image:linear-gradient(to right, var(--tw-gradient-stops))}.from-blue-600{--tw-gradient-from:#2563eb;--tw-gradient-to:rgb(37 99 235 / 0);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.from-green-500{--tw-gradient-from:#22c55e;--tw-gradient-to:rgb(34 197 94 / 0);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.to-emerald-600{--tw-gradient-to:#059669}.to-indigo-700{--tw-gradient-to:#4338ca}.p-1{padding:.25rem}.p-2{padding:.5rem}.p-3{padding:.75rem}.p-4{padding:1rem}.p-6{padding:1.5rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-4{padding-left:1rem;padding-right:1rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.py-3{padding-top:.75rem;padding-bottom:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.pt-2{padding-top:.5rem}.pt-3{padding-top:.75rem}.font-mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}.text-center{text-align:center}.text-left{text-align:left}.text-right{text-align:right}.text-xs{font-size:.75rem;line-height:1rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.font-normal{font-weight:400}.font-bold{font-weight:700}.font-semibold{font-weight:600}.uppercase{text-transform:uppercase}.text-white{color:#fff}.text-black{color:#000}.text-gray-400{color:#9ca3af}.text-gray-500{color:#6b7280}.text-gray-600{color:#4b5563}.text-gray-700{color:#374151}.text-gray-800{color:#1f2937}.text-blue-200{color:#bfdbfe}.text-blue-400{color:#60a5fa}.text-blue-500{color:#3b82f6}.text-blue-600{color:#2563eb}.text-blue-700{color:#1d4ed8}.text-blue-800{color:#1e40af}.text-green-600{color:#16a34a}.text-green-700{color:#15803d}.text-green-800{color:#166534}.text-indigo-200{color:#c7d2fe}.text-indigo-300{color:#a5b4fc}.text-indigo-400{color:#818cf8}.text-indigo-500{color:#6366f1}.text-indigo-700{color:#4338ca}.text-indigo-800{color:#3730a3}.text-orange-200{color:#fed7aa}.text-orange-400{color:#fb923c}.text-orange-600{color:#ea580c}.text-orange-700{color:#c2410c}.text-orange-800{color:#9a3412}.text-purple-600{color:#9333ea}.text-purple-700{color:#7e22ce}.text-red-200{color:#fecaca}.text-red-400{color:#f87171}.text-red-500{color:#ef4444}.text-red-600{color:#dc2626}.text-red-800{color:#991b1b}.text-yellow-600{color:#ca8a04}.text-yellow-800{color:#854d0e}.opacity-0{opacity:0}.shadow-lg{--tw-shadow:0 10px 15px -3px #0000001a, 0 4px 6px -4px #0000001a;--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-xl{--tw-shadow:0 20px 25px -5px #0000001a, 0 8px 10px -6px #0000001a;--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color), 0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-2xl{--tw-shadow:0 25px 50px -12px #00000040;--tw-shadow-colored:0 25px 50px -12px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 2px 0 #0000000d;--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.transition-colors{transition-property:color, background-color, border-color, text-decoration-color, fill, stroke;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.duration-200{transition-duration:.2s}.duration-300{transition-duration:.3s}.first\:border-t-0:first-child{border-top-width:0px}.first\:pt-0:first-child{padding-top:0px}.first\:mt-0:first-child{margin-top:0px}.hover\:scale-\[1\.02\]:hover{--tw-scale-x:1.02;--tw-scale-y:1.02;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.hover\:bg-gray-100:hover{background-color:#f3f4f6}.hover\:bg-gray-200:hover{background-color:#e5e7eb}.hover\:bg-gray-300:hover{background-color:#d1d5db}.hover\:bg-green-600:hover{background-color:#16a34a}.hover\:bg-indigo-600:hover{background-color:#4f46e5}.hover\:bg-red-600:hover{background-color:#dc2626}.hover\:bg-yellow-500:hover{background-color:#eab308}.hover\:text-red-700:hover{color:#b91c1c}.hover\:shadow-xl:hover{--tw-shadow:0 20px 25px -5px #0000001a, 0 8px 10px -6px #0000001a;--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color), 0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}
        .success-icon .checkmark-path { stroke-dasharray: 100; stroke-dashoffset: 100; animation: draw-check 0.5s ease-in-out forwards; }
        @keyframes draw-check { to { stroke-dashoffset: 0; } }
        .stats-view-btn.active { background-color: #3b82f6; color: white; }
    </style>
    <style>
        /* Dark Mode Styles */
        html.dark { color-scheme: dark; }
        html.dark body { background-color: #111827; color: #d1d5db; }
        html.dark #app, html.dark .bg-white { background-color: #1f2937; color: #d1d5db; }
        html.dark .bg-gray-50, html.dark .bg-green-50, html.dark .bg-indigo-50, html.dark .bg-orange-50, html.dark .bg-red-50 { background-color: #374151; }
        html.dark .bg-blue-50 { background-color: #1e3a8a66; }
        html.dark .bg-gray-100 { background-color: #111827; }
        html.dark .bg-indigo-200 { background-color: #4338ca; }
        html.dark .bg-green-100 { background-color: #166534; }
        html.dark .bg-green-200 { background-color: #166534; }
        html.dark .bg-yellow-50 { background-color: #854d0e20; }
        html.dark .text-gray-500, html.dark .text-gray-600 { color: #9ca3af; }
        html.dark .text-gray-700, html.dark .dropdown-item-title { color: #f9fafb; }
        html.dark .text-green-700 { color: #6ee7b7; }
        html.dark .text-green-800, html.dark .text-blue-800, html.dark .text-orange-800, html.dark .text-indigo-800, html.dark .text-yellow-800, html.dark .text-red-800 { color: #e5e7eb; }
        html.dark .border-gray-200, html.dark .border-green-200, html.dark .border-indigo-200, html.dark .border-blue-200, html.dark .border-orange-200, html.dark .border-red-200 { border-color: #4b5563; }
        html.dark input, html.dark select { background-color: #4b5563; color: #f9fafb; border-color: #6b7280; }
        html.dark select { background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23d1d5db' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); }
        html.dark .tab { color: #9ca3af; }
        html.dark .tab-active { background-color: #374151; }
        html.dark .dropdown-content { background-color: #374151; }
        html.dark .dropdown-item { background-color: #4b5563; border-color: #6b7280; }
        html.dark .stats-view-btn.active { background-color: #2563eb; }
        html.dark .stats-view-btn { background-color: #4b5563; }
        html.dark .hover\:bg-gray-200:hover { background-color: #374151; }
        /* Autocomplete styles */
        .autocomplete-item { transition: background-color 0.1s ease-in-out; }
        html.dark .autocomplete-list { background-color: #4b5563; border-color: #6b7280; color: #f9fafb; }
        html.dark .autocomplete-item:hover { background-color: #6b7280; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app" class="max-w-md mx-auto bg-white min-h-screen">
        <div class="bg-blue-600 text-white p-4">
            <h1 class="text-xl font-bold text-center">Munkaidő Nyilvántartó Pro</h1>
        </div>
        <div class="flex bg-gray-100 shadow-sm">
            <button onclick="showTab('live')" id="tab-live" class="tab tab-active">📊 Áttekintés</button>
            <button onclick="showTab('full-day')" id="tab-full-day" class="tab">➕ Teljes nap</button>
            <button onclick="showTab('list')" id="tab-list" class="tab">📅 Lista</button>
            <div id="dropdown-container" class="relative flex-1">
                <button onclick="toggleDropdown()" id="dropdown-button" class="tab w-full">Továbbiak ▼</button>
                <div id="dropdown-menu" class="dropdown-content hidden">
                    <button onclick="showTab('summary')" class="dropdown-item"><span class="dropdown-item-icon">📊</span><div><p class="dropdown-item-title">Összesítő</p><p class="dropdown-item-desc">Napi, heti és havi adatok</p></div></button>
                    <button onclick="showTab('stats')" class="dropdown-item"><span class="dropdown-item-icon">📈</span><div><p class="dropdown-item-title">Statisztika</p><p class="dropdown-item-desc">Részletes, lapozható diagramok</p></div></button>
                    <button onclick="showTab('tachograph')" class="dropdown-item"><span class="dropdown-item-icon">⏱️</span><div><p class="dropdown-item-title">Tachográf</p><p class="dropdown-item-desc">Vezetési és pihenőidő elemzés</p></div></button>
                    <button onclick="showTab('report')" class="dropdown-item"><span class="dropdown-item-icon">📋</span><div><p class="dropdown-item-title">Riport</p><p class="dropdown-item-desc">Nyomtatható havi elszámolás</p></div></button>
                    <button onclick="showTab('settings')" class="dropdown-item"><span class="dropdown-item-icon">⚙️</span><div><p class="dropdown-item-title">Beállítások</p><p class="dropdown-item-desc">Adatmentés és személyes adatok</p></div></button>
                </div>
            </div>
        </div>
        <div class="p-4">
            <div id="content-live" class="space-y-4">
                <div id="live-start-view">
                    <div id="live-allowance-display" class="mb-4"></div>
                    <div id="dashboard" class="mb-4 space-y-4">
                        <h2 class="text-xl font-bold">Áttekintés</h2>
                        <div id="dashboard-cards" class="grid grid-cols-2 gap-3">
                            </div>
                    </div>
                    <div class="p-4 bg-green-50 border border-green-200 rounded-lg space-y-3">
                        <h3 class="font-semibold text-lg text-green-800">Új munkanap indítása</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm mb-1">Dátum</label><input type="date" id="liveStartDate" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm mb-1">Idő</label><input type="time" id="liveStartTime" onblur="formatTimeInput(this)" class="w-full p-2 border rounded"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="relative z-10"><label class="block text-sm mb-1">Hely</label><input type="text" id="liveStartLocation" class="w-full p-2 border rounded" placeholder="Város"></div>
                            <div><label class="block text-sm mb-1">Heti vezetés</label><input type="text" id="liveWeeklyDriveStart" onblur="formatTimeInput(this, true)" class="w-full p-2 border rounded" placeholder="óó:pp"></div>
                        </div>
                        <div><label class="block text-sm mb-1">Kezdő km</label><input type="number" id="liveStartKm" class="w-full p-2 border rounded" placeholder="0"></div>
                        <button onclick="startLiveShift()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 text-base"><span class="text-2xl">🚀</span> Munkanap indítás</button>
                    </div>
                </div>
                <div id="live-progress-view" class="hidden space-y-4">
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-lg"><p class="font-bold">Munkanap folyamatban</p><p id="live-start-time" class="text-sm"></p></div>
                    <div class="bg-indigo-50 dark:bg-indigo-900/50 border border-indigo-200 dark:border-indigo-800 rounded-lg p-3">
                        <h3 class="font-semibold text-indigo-800 dark:text-indigo-200 mb-2">🛂 Új Határátlépés</h3>
                        <div id="live-crossings-list" class="text-sm space-y-1 mb-3"></div>
                        <div class="space-y-2 border-t border-indigo-200/50 pt-2">
                            <div class="grid grid-cols-2 gap-2">
                                <div><input type="text" id="liveCrossFrom" placeholder="Honnan" class="w-full p-2 border rounded text-sm uppercase"></div>
                                <div>
                                    <div class="flex">
                                        <input type="text" id="liveCrossTo" placeholder="Hova" class="w-full p-2 border rounded-l text-sm uppercase">
                                        <button onclick="fetchCountryCodeFor('liveCrossTo')" class="bg-blue-500 text-white p-2 rounded-r text-xs" title="Országkód lekérése GPS alapján">📍</button>
                                    </div>
                                </div>
                            </div>
                            <input type="time" id="liveCrossTime" onblur="formatTimeInput(this)" class="w-full p-2 border rounded text-sm">
                            <button onclick="addLiveCrossing()" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg text-sm">+ Határátlépés hozzáadása</button>
                        </div>
                    </div>
                    <button onclick="finalizeShift()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-700 text-white font-bold py-4 px-4 rounded-lg flex items-center justify-center gap-3 text-lg shadow-lg hover:shadow-xl transition-all duration-200 hover:scale-[1.02]"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6H8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"></path></svg>Műszak Befejezése</button>
                    <button onclick="discardShift()" class="w-full text-sm text-red-500 hover:text-red-700 mt-2">Munkanap elvetése</button>
                </div>
            </div>
            <div id="content-full-day" class="hidden space-y-4">
                <h2 class="text-xl font-bold">Teljes munkanap rögzítése</h2>
                <div><label class="block text-sm font-medium mb-1">Dátum (a munka befejezésének napja)</label><input type="date" id="date" class="w-full p-2 border rounded-lg"></div>
                <div class="bg-green-50 border border-green-200 rounded-lg p-3 space-y-3">
                    <h3 class="font-semibold text-green-800">🕐 Munkaidő és Helyszín</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="block text-xs mb-1">Kezdés ideje</label><input type="time" id="startTime" onblur="formatTimeInput(this)" class="w-full p-2 border rounded text-sm"></div>
                        <div><label class="block text-xs mb-1">Befejezés ideje</label><input type="time" id="endTime" onblur="formatTimeInput(this)" class="w-full p-2 border rounded text-sm"></div>
                    </div>
                    <div id="compensation-group" class="hidden">
                        <label class="block text-xs mb-1 text-yellow-700">Kompenzáció / Szünet (levonódik)</label>
                        <input type="text" id="compensationTime" onblur="formatTimeInput(this, true)" class="w-full p-2 border border-yellow-400 rounded text-sm" placeholder="óó:pp">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="relative z-10"><label class="block text-xs mb-1">Kezdés helye</label><input type="text" id="startLocation" class="w-full p-2 border rounded text-sm" placeholder="Város"></div>
                        <div class="relative z-10"><label class="block text-xs mb-1">Befejezés helye</label><div class="flex"><input type="text" id="endLocation" class="w-full p-2 border rounded-l text-sm" placeholder="Város"><button onclick="fetchLocation()" class="bg-blue-500 text-white p-2 rounded-r text-xs" title="Helyszín lekérése GPS alapján">📍</button></div></div>
                    </div>
                    <div id="workTimeDisplay" class="text-sm text-green-700"></div><div id="nightWorkDisplay" class="text-sm text-purple-700"></div>
                </div>
                <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-3">
                    <h3 class="font-semibold text-indigo-800 mb-2">🛂 Határátlépések</h3>
                    <div id="crossingsContainer" class="space-y-2"></div>
                    <button onclick="addCrossingRow()" class="w-full mt-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg text-sm">+ Új átlépés hozzáadása</button>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <h3 class="font-semibold text-blue-800 mb-2">🚗 Heti vezetési idő (óra)</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="block text-xs mb-1">Nap elején (óó:pp)</label><input type="text" id="weeklyDriveStart" onblur="formatTimeInput(this, true)" class="w-full p-2 border rounded text-sm" placeholder="28:24"></div>
                        <div><label class="block text-xs mb-1">Nap végén (óó:pp)</label><input type="text" id="weeklyDriveEnd" onblur="formatTimeInput(this, true)" class="w-full p-2 border rounded text-sm" placeholder="32:44"></div>
                    </div>
                    <div id="driveTimeDisplay" class="mt-2 text-sm text-blue-700"></div>
                </div>
                <div class="bg-orange-50 border border-orange-200 rounded-lg p-3">
                    <h3 class="font-semibold text-orange-800 mb-2">📏 Kilométer állás</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="block text-xs mb-1">Kezdő km</label><input type="number" id="kmStart" class="w-full p-2 border rounded text-sm" placeholder="0"></div>
                        <div><label class="block text-xs mb-1">Záró km</label><input type="number" id="kmEnd" class="w-full p-2 border rounded text-sm" placeholder="0"></div>
                    </div>
                    <div id="kmDisplay" class="mt-2 text-sm text-orange-700"></div>
                </div>
                <button onclick="saveEntry()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-3 text-base shadow-lg hover:shadow-xl transition-all duration-200 hover:scale-[1.02] mt-4"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Bejegyzés Mentése</button>
            </div>
            <div id="content-list" class="hidden"><h2 class="text-lg font-semibold mb-4">Bejegyzések</h2><div id="recordsContent"></div></div>
            <div id="content-summary" class="hidden"><h2 class="text-lg font-semibold mb-4">Összesítések</h2><div id="summaryContent" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div></div>
            <div id="content-stats" class="hidden space-y-4">
                <h2 class="text-xl font-bold">Részletes Statisztikák</h2>
                <div class="bg-gray-100 p-2 rounded-lg space-y-3">
                    <div class="grid grid-cols-3 gap-2">
                        <button id="stats-view-daily" class="stats-view-btn text-sm py-2 rounded-md bg-gray-200">Napi</button>
                        <button id="stats-view-monthly" class="stats-view-btn text-sm py-2 rounded-md bg-gray-200">Havi</button>
                        <button id="stats-view-yearly" class="stats-view-btn text-sm py-2 rounded-md bg-gray-200">Éves</button>
                    </div>
                    <div class="flex justify-between items-center">
                        <button id="stats-prev" class="p-2 rounded-full hover:bg-gray-300">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <div id="stats-period-display" class="font-semibold text-center"></div>
                        <button id="stats-next" class="p-2 rounded-full hover:bg-gray-300">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                </div>
                <div id="stats-charts-container" class="space-y-6">
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-semibold">Munkaidő</h3>
                            <span id="workTimeTotal" class="text-sm font-bold"></span>
                        </div>
                        <canvas id="workTimeChart"></canvas>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-semibold">Vezetési idő</h3>
                            <span id="driveTimeTotal" class="text-sm font-bold"></span>
                        </div>
                        <canvas id="driveTimeChart"></canvas>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-semibold">Éjszakai munka</h3>
                            <span id="nightTimeTotal" class="text-sm font-bold"></span>
                        </div>
                        <canvas id="nightTimeChart"></canvas>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2">
                           <h3 class="text-lg font-semibold">Megtett kilométer</h3>
                           <span id="kmTotal" class="text-sm font-bold"></span>
                        </div>
                       <canvas id="kmChart"></canvas>
                    </div>
                </div>
                <div id="stats-no-data" class="text-center text-gray-500 py-8 hidden">Nincs adat a kiválasztott időszakban.</div>
            </div>
            <div id="content-report" class="hidden">
                <h2 class="text-lg font-semibold mb-4">Havi riport</h2>
                <div class="mb-4"><label class="block text-sm font-medium mb-1">Hónap kiválasztása</label><input type="month" id="monthSelector" class="w-full p-2 border rounded-lg"></div>
                <button onclick="generateMonthlyReport()" class="w-full bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg mb-4">📋 Riport generálása</button>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-4">
                    <button onclick="exportToPDF()" id="pdfExportBtn" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg hidden">📄 PDF letöltés</button>
                    <button onclick="sharePDF()" id="pdfShareBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg hidden">📲 PDF megosztása</button>
                </div>
                <div id="monthlyReportContent"></div>
            </div>
            <div id="content-settings" class="hidden">
                <h2 class="text-lg font-semibold mb-4">Beállítások és Adatkezelés</h2>
                <div class="space-y-4">
                    <div id="sync-section" class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold mb-2">☁️ Felhő Szinkronizáció</h3>
                        <div id="logged-out-view">
                            <p class="text-sm text-gray-600 mb-3">Jelentkezz be a Google fiókoddal, hogy az adataidat a felhőbe mentsd és több eszközön is elérd.</p>
                            <button id="login-button" class="w-full bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg inline-flex items-center justify-center gap-2 hover:bg-gray-50">
                                <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.215,44,30.035,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                                Bejelentkezés Google-fiókkal
                            </button>
                        </div>
                        <div id="logged-in-view" class="hidden">
                            <p class="text-sm text-gray-600 mb-3">Bejelentkezve mint: <strong id="user-name"></strong></p>
                            <button id="logout-button" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Kijelentkezés</button>
                        </div>
                    </div>
                     <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold mb-2">Személyes adatok</h3>
                        <label class="block text-sm font-medium mb-1">Név (riportokhoz)</label>
                        <input type="text" id="userNameInput" class="w-full p-2 border rounded-lg mb-3" placeholder="Vezetéknév Keresztnév">
                        <button onclick="saveSettings()" class="w-full btn-primary">Adatok mentése</button>
                    </div>
                     <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold mb-2">Megjelenés</h3>
                        <label for="themeSelector" class="block text-sm text-gray-600 mb-1">Válassz témát</label>
                        <select id="themeSelector" onchange="setTheme(this.value)" class="w-full p-2 border rounded-lg bg-white">
                            <option value="auto">Automatikus</option>
                            <option value="light">Nappali</option>
                            <option value="dark">Éjszakai</option>
                        </select>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold mb-2">Speciális funkciók</h3>
                        <label for="sassiModeToggle" id="sassiModeLabel" class="flex items-center justify-between cursor-pointer p-2 rounded-lg transition-colors">
                            <span class="text-gray-700 dark:text-gray-300">
                                Sassinak 😉 <span class="sassi-checkmark hidden font-bold text-lg text-green-600">✓</span>
                            </span>
                            <div class="relative">
                                <input type="checkbox" id="sassiModeToggle" class="sr-only">
                                <div class="block bg-gray-300 dark:bg-gray-600 w-14 h-8 rounded-full"></div>
                                <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
                            </div>
                        </label>
                        <p class="text-xs text-gray-500 mt-2 pl-2">Bekapcsolásával elérhetővé válik a munkaidő kompenzáció (szünet) megadása a munkanap rögzítésénél.</p>
                    </div>
                    <style>
                        #sassiModeToggle:checked ~ .dot { transform: translateX(100%); }
                        #sassiModeToggle:checked ~ .block { background-color: #22c55e; }
                    </style>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold mb-2">Adatok exportálása (Backup)</h3>
                        <p class="text-sm text-gray-600 mb-2">Mentsd le az összes bejegyzésedet egy JSON fájlba.</p>
                        
                        <div class="mb-4">
                            <label for="autoExportSelector" class="block text-sm font-medium text-gray-700 mb-1">Automatikus mentés gyakorisága:</label>
                            <select id="autoExportSelector" class="w-full p-2 border rounded-lg bg-white">
                                <option value="never">Soha</option>
                                <option value="daily">Naponta</option>
                                <option value="weekly">Hetente</option>
                                <option value="monthly">Havonta</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Az alkalmazás indításakor ellenőrzi, hogy esedékes-e a mentés.</p>
                        </div>

                        <button onclick="exportData()" class="w-full btn-secondary">📥 Adatok letöltése</button>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold mb-2">Adatok importálása</h3>
                        <p class="text-sm text-gray-600 mb-3">Tölts vissza egy korábban lementett adatfájlt. Figyelem: ez felülírja a jelenlegi adatokat!</p>
                        <input type="file" id="importFile" accept=".json" class="w-full text-sm">
                        <button onclick="importData()" class="w-full btn-primary mt-3">📤 Adatok visszatöltése</button>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 flex items-center gap-3">
                        <span class="text-2xl">ℹ️</span>
                        <div>
                            <h3 class="font-semibold">Munkaidő PRO</h3>
                            <p class="text-sm text-gray-600">Készítette: Princz Attila</p>
                            <p class="text-xs text-gray-500 mt-1">Verzió: 6.12</p>
                        </div>
                    </div>
                </div>
            </div>
            <div id="content-tachograph" class="hidden">
                <h2 class="text-xl font-bold mb-4">Tachográf Elemzés</h2>
                <div id="tacho-allowance-display" class="mb-4"></div>
                <div id="tachograph-list" class="space-y-3"></div>
            </div>
        </div>
    </div>
    <div id="custom-alert-overlay" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 transition-opacity duration-300">
        <div id="custom-alert-box" class="bg-white rounded-xl p-6 shadow-2xl w-11/12 max-w-sm mx-auto transform transition-transform duration-300 scale-95">
            <div id="custom-alert-icon" class="w-16 h-16 mx-auto mb-5 rounded-full flex items-center justify-center"></div>
            <p id="custom-alert-message" class="text-center text-lg text-gray-700 mb-6"></p>
            <div id="custom-alert-buttons" class="flex justify-center gap-4"></div>
        </div>
    </div>
	
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyDGgG3y0ppl4639bzjzKA7Yq8BmSkhR-LU",
        authDomain: "munkaido-3cc44.firebaseapp.com",
        projectId: "munkaido-3cc44",
        storageBucket: "munkaido-3cc44.firebasestorage.app",
        messagingSenderId: "706081294435",
        appId: "1:706081294435:web:c8ae57cbe45477de415056"
      };
      firebase.initializeApp(firebaseConfig);
    </script>
	
    <script>
        // =======================================================
        // ===== FIREBASE ÉS AUTHENTIKÁCIÓS LOGIKA (v6.12) =======
        // =======================================================
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const loggedInView = document.getElementById('logged-in-view');
        const loggedOutView = document.getElementById('logged-out-view');
        const userNameEl = document.getElementById('user-name');
        if (loginButton) {
            loginButton.addEventListener('click', async () => {
                const originalButtonContent = loginButton.innerHTML;
                loginButton.disabled = true;
                loginButton.innerHTML = `Bejelentkezés...`;
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    await auth.signInWithPopup(provider);
                } catch (error) {
                    let errorMessage = 'Bejelentkezési hiba történt.';
                    if (error.code === 'auth/popup-closed-by-user') {
                        errorMessage = 'A bejelentkezési ablakot bezárta.';
                    } else if (error.code === 'auth/popup-blocked') {
                        errorMessage = 'A böngésző blokkolta a felugró ablakot. Kérjük, engedélyezze.';
                    }
                    console.error('Bejelentkezési hiba:', error);
                    showCustomAlert(errorMessage, 'info');
                } finally {
                    loginButton.disabled = false;
                    loginButton.innerHTML = originalButtonContent;
                }
            });
        }
        if (logoutButton) { logoutButton.addEventListener('click', () => { auth.signOut(); }); }
        auth.onAuthStateChanged(async user => {
            currentUser = user;
            updateAuthUI(user);
            if (user) {
                console.log("Bejelentkezve:", user.uid);
                const firestoreRecords = await loadRecordsFromFirestore();
                const localRecords = getRecordsFromLocal();
                if (firestoreRecords.length === 0 && localRecords.length > 0) {
                    console.log("Adatok migrálása a felhőbe...");
                    await migrateLocalToFirestore(localRecords);
                    records = localRecords;
                } else {
                    records = firestoreRecords;
                }
            } else {
                console.log("Kijelentkezve.");
                records = getRecordsFromLocal();
            }
            renderApp();
            checkForAutoExport();
        });
        function updateAuthUI(user) { if (user) { loggedInView.classList.remove('hidden'); loggedOutView.classList.add('hidden'); userNameEl.textContent = user.displayName || user.email; } else { loggedInView.classList.add('hidden'); loggedOutView.classList.remove('hidden'); userNameEl.textContent = ''; } }
        async function migrateLocalToFirestore(localRecords) { if (!currentUser) return; const batch = db.batch(); localRecords.forEach(record => { const docRef = db.collection('users').doc(currentUser.uid).collection('records').doc(String(record.id)); batch.set(docRef, record); }); try { await batch.commit(); } catch (error) { console.error("Hiba a helyi adatok feltöltésekor:", error); showCustomAlert('Hiba történt a helyi adatok felhőbe töltésekor.', 'info'); } }
        function getRecordsFromLocal() { return JSON.parse(localStorage.getItem('workRecords') || '[]'); }
        async function loadRecordsFromFirestore() { if (!currentUser) return []; try { const snapshot = await db.collection('users').doc(currentUser.uid).collection('records').get(); return snapshot.docs.map(doc => doc.data()); } catch (error) { console.error("Hiba az adatok Firestore-ból való letöltésekor:", error); showCustomAlert("Hiba az adatok letöltésekor a felhőből.", 'info'); return []; } }
        async function saveRecord(record) { if (editingId) { records = records.map(r => r.id === editingId ? record : r); } else { records.push(record); } if (currentUser) { try { await db.collection('users').doc(currentUser.uid).collection('records').doc(String(record.id)).set(record); } catch (error) { console.error("Hiba a Firestore-ba mentéskor:", error); showCustomAlert("Hiba a felhőbe mentéskor.", 'info'); } } else { localStorage.setItem('workRecords', JSON.stringify(records)); } }
        async function deleteRecordFromStorage(id) { if (currentUser) { try { await db.collection('users').doc(currentUser.uid).collection('records').doc(String(id)).delete(); } catch (error) { console.error("Hiba a Firestore-ból való törléskor:", error); showCustomAlert("Hiba a felhőből való törléskor.", 'info'); } } }

        // =======================================================
        // ===== ALKALMAZÁS LOGIKA (v6.12) =======================
        // =======================================================
        
        let records = []; 
        let editingId = null;
        let inProgressEntry = JSON.parse(localStorage.getItem('inProgressEntry') || 'null'); 
        let uniqueLocations = [];
        let statsView = 'daily';
        let statsDate = new Date();
        let workTimeChart, driveTimeChart, nightTimeChart, kmChart;

        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            loadSettings();
            initSassiMode();
            document.addEventListener('click', (event) => {
                const dropdownContainer = document.getElementById('dropdown-container');
                if (dropdownContainer && !dropdownContainer.contains(event.target)) { closeDropdown(); }
                if (!event.target.closest('.autocomplete-list') && !event.target.matches('input[placeholder="Város"]')) { hideAutocomplete(); }
            });
            document.getElementById('autoExportSelector').addEventListener('change', (e) => {
                localStorage.setItem('autoExportFrequency', e.target.value);
                if (e.target.value !== 'never') {
                    localStorage.setItem('lastAutoExportDate', new Date().toISOString());
                    showCustomAlert('Automatikus mentés bekapcsolva!', 'success');
                } else {
                    showCustomAlert('Automatikus mentés kikapcsolva.', 'info');
                }
            });
            document.getElementById('stats-view-daily').onclick = () => { statsView = 'daily'; renderStats(); };
            document.getElementById('stats-view-monthly').onclick = () => { statsView = 'monthly'; renderStats(); };
            document.getElementById('stats-view-yearly').onclick = () => { statsView = 'yearly'; renderStats(); };
            document.getElementById('stats-prev').onclick = () => { navigateStats(-1); };
            document.getElementById('stats-next').onclick = () => { navigateStats(1); };
        });

        function renderApp() {
            renderWeeklyAllowance();
            renderRecords();
            renderSummary();
            renderLiveTabView();
            updateUniqueLocations();
            initAllAutocomplete();
        }

        const isoToVehicleCode = { 'at': 'A', 'de': 'D', 'hu': 'H', 'sk': 'SK', 'si': 'SLO', 'it': 'I', 'pl': 'PL', 'cz': 'CZ', 'ro': 'RO', 'ch': 'CH', 'fr': 'F', 'nl': 'NL', 'be': 'B', 'lu': 'L', 'es': 'E', 'gb': 'UK' };
        async function fetchCountryCodeFor(inputId) { const inputElement = document.getElementById(inputId); if (!inputElement || !navigator.geolocation) return; inputElement.value = "Keresés..."; try { const position = await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 })); const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.coords.latitude}&lon=${position.coords.longitude}&accept-language=en`); if (!response.ok) throw new Error('API hiba'); const data = await response.json(); const countryCode = data.address.country_code; if (countryCode && isoToVehicleCode[countryCode]) { inputElement.value = isoToVehicleCode[countryCode]; } else { inputElement.value = (countryCode || 'N/A').toUpperCase(); } } catch (error) { inputElement.value = ""; showCustomAlert(`Helyszín lekérése sikertelen.`, 'info'); } }
        function toggleDropdown() { document.getElementById('dropdown-menu').classList.toggle('hidden'); }
        function closeDropdown() { document.getElementById('dropdown-menu').classList.add('hidden'); }
        let alertCallback = null;
        function showCustomAlert(message, type, callback) { const overlay = document.getElementById('custom-alert-overlay'); const box = document.getElementById('custom-alert-box'); const iconContainer = document.getElementById('custom-alert-icon'); const messageEl = document.getElementById('custom-alert-message'); const buttonsContainer = document.getElementById('custom-alert-buttons'); messageEl.textContent = message; alertCallback = callback || null; iconContainer.className = 'w-16 h-16 mx-auto mb-5 rounded-full flex items-center justify-center'; buttonsContainer.innerHTML = ''; const warningIcon = `<svg class="w-10 h-10 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`; if (type === 'warning') { iconContainer.classList.add('bg-yellow-100'); iconContainer.innerHTML = warningIcon; buttonsContainer.innerHTML = `<button onclick="hideCustomAlert(false)" class="py-2 px-6 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">Mégse</button><button onclick="hideCustomAlert(true)" class="py-2 px-6 bg-yellow-400 text-white rounded-lg font-semibold hover:bg-yellow-500">Mentés</button>`; } else if (type === 'info') { iconContainer.classList.add('bg-yellow-100'); iconContainer.innerHTML = warningIcon; buttonsContainer.innerHTML = `<button onclick="hideCustomAlert(true)" class="py-2 w-2/3 bg-yellow-400 text-white rounded-lg font-semibold hover:bg-yellow-500">Oké</button>`; } else if (type === 'success') { iconContainer.classList.add('bg-green-100', 'success-icon'); iconContainer.innerHTML = `<svg class="w-10 h-10 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path class="checkmark-path" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`; buttonsContainer.innerHTML = `<button onclick="hideCustomAlert(true)" class="py-2 w-2/3 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600">Rendben</button>`; } overlay.classList.remove('hidden'); overlay.classList.add('flex'); setTimeout(() => { overlay.classList.remove('opacity-0'); box.classList.remove('scale-95'); }, 10); }
        function hideCustomAlert(isConfirmed) { const overlay = document.getElementById('custom-alert-overlay'); const box = document.getElementById('custom-alert-box'); overlay.classList.add('opacity-0'); box.classList.add('scale-95'); setTimeout(() => { overlay.classList.add('hidden'); overlay.classList.remove('flex'); if (isConfirmed && alertCallback) { alertCallback(); } alertCallback = null; }, 300); }
        async function saveEntry() {
            const recordData = {
                date: document.getElementById('date').value,
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                startLocation: document.getElementById('startLocation').value.trim(),
                endLocation: document.getElementById('endLocation').value.trim(),
                weeklyDriveStartStr: document.getElementById('weeklyDriveStart').value.trim(),
                weeklyDriveEndStr: document.getElementById('weeklyDriveEnd').value.trim(),
                kmStart: parseFloat(document.getElementById('kmStart').value) || 0,
                kmEnd: parseFloat(document.getElementById('kmEnd').value) || 0,
                compensationTime: document.getElementById('compensationTime').value.trim(),
                crossings: Array.from(document.querySelectorAll('#crossingsContainer .border-t')).map(row => ({
                    from: row.querySelector(`input[id^="crossFrom-"]`).value.trim().toUpperCase(),
                    to: row.querySelector(`input[id^="crossTo-"]`).value.trim().toUpperCase(),
                    time: row.querySelector(`input[id^="crossTime-"]`).value
                })).filter(c => c.from && c.to && c.time)
            };

            if (!recordData.date || !recordData.startTime || !recordData.endTime) { showCustomAlert('A dátum és a munkaidő megadása kötelező!', 'info'); return; }
            if (recordData.kmEnd > 0 && recordData.kmEnd < recordData.kmStart) { showCustomAlert('Hiba: A záró kilométer nem lehet kevesebb, mint a kezdő!', 'info'); return; }
            if (parseTimeToMinutes(recordData.weeklyDriveEndStr) > 0 && parseTimeToMinutes(recordData.weeklyDriveEndStr) < parseTimeToMinutes(recordData.weeklyDriveStartStr)) { showCustomAlert('Hiba: A heti vezetési idő a nap végén nem lehet kevesebb, mint a nap elején!', 'info'); return; }

            const compensationMinutes = parseTimeToMinutes(recordData.compensationTime) || 0;
            const grossWorkMinutes = calculateWorkMinutes(recordData.startTime, recordData.endTime);

            const newRecord = {
                ...recordData,
                id: editingId || String(Date.now()),
                workMinutes: Math.max(0, grossWorkMinutes - compensationMinutes),
                compensationMinutes: compensationMinutes,
                nightWorkMinutes: calculateNightWorkMinutes(recordData.startTime, recordData.endTime),
                driveMinutes: Math.max(0, parseTimeToMinutes(recordData.weeklyDriveEndStr) - parseTimeToMinutes(recordData.weeklyDriveStartStr)),
                kmDriven: Math.max(0, recordData.kmEnd - recordData.kmStart)
            };

            const proceedWithSave = async () => {
                await saveRecord(newRecord);
                showCustomAlert('Bejegyzés sikeresen mentve!', 'success', () => {
                    if (inProgressEntry) {
                        localStorage.removeItem('inProgressEntry');
                        inProgressEntry = null;
                    }
                    editingId = null;
                    showTab('list');
                    renderApp();
                });
            };

            if (newRecord.driveMinutes === 0 || newRecord.kmDriven === 0) {
                showCustomAlert('A vezetési idő vagy a megtett kilométer 0. Biztosan így szeretnéd menteni?', 'warning', proceedWithSave);
            } else {
                proceedWithSave();
            }
        }
        function showTab(tabName) { const allTabs = document.querySelectorAll('.tab'); const mainTabs = ['live', 'full-day', 'list']; const dropdownButton = document.getElementById('dropdown-button'); const dropdownMenu = document.getElementById('dropdown-menu'); allTabs.forEach(t => t.classList.remove('tab-active')); dropdownButton.classList.remove('tab-active'); if (mainTabs.includes(tabName)) { document.getElementById(`tab-${tabName}`).classList.add('tab-active'); dropdownButton.innerHTML = 'Továbbiak ▼'; } else { dropdownButton.classList.add('tab-active'); const selectedTitle = dropdownMenu.querySelector(`button[onclick="showTab('${tabName}')"] .dropdown-item-title`).innerText; dropdownButton.innerHTML = `${selectedTitle} ▼`; } document.querySelectorAll('[id^="content-"]').forEach(c => c.classList.add('hidden')); document.getElementById(`content-${tabName}`).classList.remove('hidden'); closeDropdown(); if (tabName === 'list') renderRecords(); if (tabName === 'summary') renderSummary(); if (tabName === 'stats') { statsDate = new Date(); renderStats(); } if (tabName === 'report') initMonthlyReport(); if (tabName === 'tachograph') renderTachographAnalysis(); }
        function renderDashboard() { const container = document.getElementById('dashboard-cards'); const now = new Date(); const thisWeek = calculateSummaryForDateRange(getWeekRange(now)); const lastWeek = calculateSummaryForDateRange(getWeekRange(now, -1)); const thisMonth = calculateSummaryForMonth(now); const cards = [ { label: 'Vezetés ezen a héten', value: formatDuration(thisWeek.driveMinutes), color: 'blue' }, { label: 'Munkaidő ezen a héten', value: formatDuration(thisWeek.workMinutes), color: 'green' }, { label: 'Távolság ebben a hónapban', value: `${thisMonth.kmDriven} km`, color: 'orange' }, { label: 'Múlt heti távolság', value: `${lastWeek.kmDriven} km`, color: 'indigo' } ]; container.innerHTML = cards.map(card => ` <div class="bg-${card.color}-50 border border-${card.color}-200 rounded-lg p-3 text-center"> <p class="text-xs text-${card.color}-700 font-semibold">${card.label}</p> <p class="text-lg font-bold text-${card.color}-800 mt-1">${card.value}</p> </div> `).join(''); }
        function renderLiveTabView() {
            inProgressEntry = JSON.parse(localStorage.getItem('inProgressEntry') || 'null');
            const startView = document.getElementById('live-start-view');
            const progressView = document.getElementById('live-progress-view');
            if (inProgressEntry) {
                startView.classList.add('hidden');
                progressView.classList.remove('hidden');
                document.getElementById('live-start-time').textContent = `Elkezdve: ${inProgressEntry.date} ${inProgressEntry.startTime}`;
                const liveCrossList = document.getElementById('live-crossings-list');
                const liveCrossFrom = document.getElementById('liveCrossFrom');
                if (inProgressEntry.crossings && inProgressEntry.crossings.length > 0) {
                    const crossingsHTML = inProgressEntry.crossings.map(c => 
                        `<div class="flex items-center justify-between bg-white dark:bg-gray-700/50 p-2 rounded-md shadow-sm">
                            <div class="flex items-center gap-2">
                                <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                                <span class="font-mono font-bold text-indigo-800 dark:text-indigo-200">${c.from}</span>
                                <span class="text-gray-400">→</span>
                                <span class="font-mono font-bold text-indigo-800 dark:text-indigo-200">${c.to}</span>
                            </div>
                            <span class="text-sm font-mono text-gray-600 dark:text-gray-400">${c.time}</span>
                        </div>`
                    ).join('');
                    liveCrossList.innerHTML = `<div class="bg-indigo-50 dark:bg-indigo-900/50 p-3 rounded-lg">
                                                <h4 class="font-bold text-indigo-800 dark:text-indigo-200 text-sm mb-2">Rögzített átlépések:</h4>
                                                <div class="space-y-2">${crossingsHTML}</div>
                                            </div>`;
                    liveCrossFrom.value = inProgressEntry.crossings.slice(-1)[0].to;
                } else {
                    liveCrossList.innerHTML = '';
                    const lastRecordWithCrossing = getSortedRecords().find(r => r.crossings && r.crossings.length > 0);
                    liveCrossFrom.value = lastRecordWithCrossing ? lastRecordWithCrossing.crossings.slice(-1)[0].to : '';
                }
                document.getElementById('liveCrossTo').value = '';
                document.getElementById('liveCrossTime').value = new Date().toTimeString().slice(0, 5);
            } else {
                progressView.classList.add('hidden');
                startView.classList.remove('hidden');
                renderDashboard();
                loadLastValues(true);
            }
        }
        function startLiveShift() { inProgressEntry = { date: document.getElementById('liveStartDate').value, startTime: document.getElementById('liveStartTime').value, startLocation: document.getElementById('liveStartLocation').value.trim(), weeklyDriveStartStr: document.getElementById('liveWeeklyDriveStart').value.trim(), kmStart: parseFloat(document.getElementById('liveStartKm').value) || 0, crossings: [] }; if (!inProgressEntry.date || !inProgressEntry.startTime) { showCustomAlert("A dátum és az indulási idő megadása kötelező!", "info"); return; } localStorage.setItem('inProgressEntry', JSON.stringify(inProgressEntry)); renderLiveTabView(); }
        function addLiveCrossing() { const from = document.getElementById('liveCrossFrom').value.trim().toUpperCase(); const to = document.getElementById('liveCrossTo').value.trim().toUpperCase(); const time = document.getElementById('liveCrossTime').value; if (!from || !to || !time) { showCustomAlert("Kérlek tölts ki minden mezőt!", "info"); return; } inProgressEntry.crossings.push({ from, to, time }); localStorage.setItem('inProgressEntry', JSON.stringify(inProgressEntry)); renderLiveTabView(); }
        function finalizeShift() { showTab('full-day'); document.getElementById('date').value = new Date().toISOString().split('T')[0]; Object.keys(inProgressEntry).forEach(key => { const el = document.getElementById(key.replace('Str', '')); if (el) el.value = inProgressEntry[key]; }); (inProgressEntry.crossings || []).forEach(c => addCrossingRow(c.from, c.to, c.time)); document.getElementById('endTime').focus(); }
        function discardShift() { if (confirm("Biztosan elveted a folyamatban lévő munkanapot?")) { localStorage.removeItem('inProgressEntry'); inProgressEntry = null; renderLiveTabView(); } }
        function getSortedRecords() { return [...(records || [])].sort((a, b) => new Date(`${b.date||"1970-01-01"}T${b.startTime||"00:00"}`) - new Date(`${a.date||"1970-01-01"}T${a.startTime||"00:00"}`)); }
        function getLatestRecord() { if (!records || records.length === 0) return null; return getSortedRecords()[0]; }
        function showFullFormView() { resetEntryForm(); loadLastValues(); }
        function loadLastValues(forLiveForm = false) { const lastRecord = getLatestRecord(); const now = new Date(); if (forLiveForm) { document.getElementById('liveStartDate').value = now.toISOString().split('T')[0]; document.getElementById('liveStartTime').value = now.toTimeString().slice(0, 5); if (lastRecord) { document.getElementById('liveStartLocation').value = lastRecord.endLocation || ''; document.getElementById('liveWeeklyDriveStart').value = lastRecord.weeklyDriveEndStr || ''; document.getElementById('liveStartKm').value = lastRecord.kmEnd || ''; } } else { document.getElementById('date').value = now.toISOString().split('T')[0]; if (lastRecord) { document.getElementById('weeklyDriveStart').value = lastRecord.weeklyDriveEndStr || ''; document.getElementById('kmStart').value = lastRecord.kmEnd || ''; document.getElementById('startLocation').value = lastRecord.endLocation || ''; } } }
        function resetEntryForm() { ['date', 'startTime', 'endTime', 'startLocation', 'endLocation', 'weeklyDriveStart', 'weeklyDriveEnd', 'kmStart', 'kmEnd'].forEach(id => document.getElementById(id).value = ''); document.getElementById('crossingsContainer').innerHTML = ''; editingId = null; updateDisplays(); }
        function updateDisplays() { const workMinutes = calculateWorkMinutes(document.getElementById('startTime').value, document.getElementById('endTime').value); document.getElementById('workTimeDisplay').textContent = workMinutes > 0 ? `Munkaidő: ${formatDuration(workMinutes)}` : ''; const nightMinutes = calculateNightWorkMinutes(document.getElementById('startTime').value, document.getElementById('endTime').value); document.getElementById('nightWorkDisplay').textContent = nightMinutes > 0 ? `Éjszakai (22:00-06:00): ${formatDuration(nightMinutes)}` : ''; const driveMinutes = Math.max(0, parseTimeToMinutes(document.getElementById('weeklyDriveEnd').value) - parseTimeToMinutes(document.getElementById('weeklyDriveStart').value)); document.getElementById('driveTimeDisplay').textContent = driveMinutes > 0 ? `Mai vezetési idő: ${formatDuration(driveMinutes)}` : ''; const kmDriven = Math.max(0, (parseFloat(document.getElementById('kmEnd').value) || 0) - (parseFloat(document.getElementById('kmStart').value) || 0)); document.getElementById('kmDisplay').textContent = kmDriven > 0 ? `Megtett km: ${kmDriven} km` : ''; }
        ['startTime', 'endTime', 'weeklyDriveStart', 'weeklyDriveEnd', 'kmStart', 'kmEnd'].forEach(id => { if (document.getElementById(id)) document.getElementById(id).addEventListener('input', updateDisplays); });
        function addCrossingRow(from = '', to = '', time = '') { const container = document.getElementById('crossingsContainer'); const lastToInput = container.querySelector('input[id^="crossTo-"]:last-of-type'); const newFrom = from || (lastToInput ? lastToInput.value.toUpperCase() : ''); const index = Date.now(); const newRow = document.createElement('div'); newRow.className = 'border-t pt-3 mt-2 space-y-2'; newRow.innerHTML = `<div class="grid grid-cols-2 gap-2"><div><input type="text" id="crossFrom-${index}" value="${newFrom}" placeholder="Honnan" class="w-full p-2 border rounded text-sm uppercase"></div><div><div class="flex"><input type="text" id="crossTo-${index}" value="${to}" placeholder="Hova" class="w-full p-2 border rounded-l text-sm uppercase"><button type="button" onclick="fetchCountryCodeFor('crossTo-${index}')" class="bg-blue-500 text-white p-2 rounded-r text-xs" title="GPS">📍</button></div></div></div><div class="grid grid-cols-2 gap-2"><input type="time" id="crossTime-${index}" value="${time}" onblur="formatTimeInput(this)" class="w-full p-2 border rounded text-sm"><button onclick="this.closest('.border-t').remove()" class="bg-red-500 text-white p-2 rounded text-sm hover:bg-red-600">Törlés</button></div>`; container.appendChild(newRow); }
        async function fetchLocation() { if (!navigator.geolocation) { showCustomAlert('A böngésződ nem támogatja a helymeghatározást.', 'info'); return; } const endLocationInput = document.getElementById('endLocation'); endLocationInput.value = "Keresés..."; try { const position = await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 })); const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.coords.latitude}&lon=${position.coords.longitude}&accept-language=hu`); if (!response.ok) throw new Error('API hiba'); const data = await response.json(); endLocationInput.value = data.address.city || data.address.town || data.address.village || 'Ismeretlen hely'; } catch (error) { endLocationInput.value = ""; showCustomAlert(`Helyszín lekérése sikertelen.`, 'info'); } }
        function editRecord(id) {
            const record = records.find(r => r.id === String(id));
            if (!record) return;
            editingId = String(id);
            showTab('full-day');
            Object.keys(record).forEach(key => {
                const el = document.getElementById(key.replace('Str', ''));
                if (el) el.value = record[key] || '';
            });
            
            const compensationEl = document.getElementById('compensationTime');
            if (compensationEl) {
                compensationEl.value = record.compensationMinutes ? formatTimeGerman(record.compensationMinutes) : '';
            }

            document.getElementById('crossingsContainer').innerHTML = '';
            (record.crossings || []).forEach(c => addCrossingRow(c.from, c.to, c.time));
            updateDisplays();
        }
        async function deleteRecord(id) { if (confirm('Biztosan törölni szeretnéd?')) { const splitData = getSplitRestData(); delete splitData[id]; saveSplitRestData(splitData); const weeklyData = getWeeklyRestData(); delete weeklyData[id]; saveWeeklyRestData(weeklyData); await deleteRecordFromStorage(id); records = records.filter(r => r.id !== String(id)); if(!currentUser) { localStorage.setItem('workRecords', JSON.stringify(records)); } renderApp(); } }
        function renderRecords() { const container = document.getElementById('recordsContent'); if (!container) return; container.innerHTML = records.length === 0 ? '<p class="text-center text-gray-500 py-8">Még nincsenek bejegyzések</p>' : getSortedRecords().map(r => { const d = new Date(r.date); const day = d.getUTCDay(); const weekendClass = (day === 6 || day === 0) ? 'bg-red-50' : ''; const isOvernight = new Date(`1970-01-01T${r.endTime}`) < new Date(`1970-01-01T${r.startTime}`); const endDate = new Date(r.date + 'T00:00:00'); let startDate = new Date(r.date + 'T00:00:00'); if (isOvernight) { startDate.setDate(startDate.getDate() - 1); } const formatShortDate = (dt) => dt.toLocaleDateString('hu-HU', { month: '2-digit', day: '2-digit' }); return `<div class="bg-gray-50 rounded-lg p-3 mb-3 text-sm ${weekendClass}"><div class="flex items-center justify-between mb-2"><div class="font-semibold">${isOvernight?`${startDate.toLocaleDateString("hu-HU")} - ${endDate.toLocaleDateString("hu-HU")}`:endDate.toLocaleDateString("hu-HU")}</div><div><button onclick="editRecord('${r.id}')" class="text-blue-500 p-1">✏️</button><button onclick="deleteRecord('${r.id}')" class="text-red-500 p-1">🗑️</button></div></div><div class="space-y-1"><div class="flex justify-between"><span>Indulás:</span><span>${isOvernight?formatShortDate(startDate):""} ${r.startTime} (${r.startLocation||"N/A"})</span></div><div class="flex justify-between"><span>Érkezés:</span><span>${formatShortDate(endDate)} ${r.endTime} (${r.endLocation||"N/A"})</span></div><div class="flex justify-between border-t pt-1 mt-1"><span>Munkaidő:</span><span class="font-bold">${formatDuration(r.workMinutes)}</span></div>${r.compensationMinutes > 0 ? `<div class="flex justify-between text-yellow-700 text-xs"><span>&nbsp;&nbsp;└ Kompenzáció:</span><span>-${formatDuration(r.compensationMinutes)}</span></div>` : ''}<div class="flex justify-between"><span>Éjszakai:</span><span class="text-purple-600">${formatDuration(r.nightWorkMinutes||0)}</span></div><div class="flex justify-between"><span>Vezetés:</span><span class="text-blue-700">${formatDuration(r.driveMinutes)}</span></div><div class="flex justify-between"><span>Távolság:</span><span>${r.kmDriven} km</span></div>${(r.crossings&&r.crossings.length>0)?`<div class="border-t pt-2 mt-2"><p class="font-semibold text-xs text-indigo-700">Határátlépések:</p><div class="text-xs text-gray-600 pl-2">${r.crossings.map(c=>`<span>${c.from} - ${c.to} (${c.time})</span>`).join("<br>")}</div></div>`:""}</div></div>`; }).join(''); }
        function renderSummary() { const container = document.getElementById('summaryContent'); if (!container) return; const today = new Date(); const summaries = [{ title: 'Ma', data: calculateSummaryForDate(new Date()) }, { title: 'Tegnap', data: calculateSummaryForDate(new Date(new Date().setDate(today.getDate() - 1))) }, { title: 'Aktuális hét', data: calculateSummaryForDateRange(getWeekRange(new Date())) }, { title: 'Múlt hét', data: calculateSummaryForDateRange(getWeekRange(new Date(), -1)) }, { title: 'Aktuális hónap', data: calculateSummaryForMonth(new Date()) }, { title: 'Előző hónap', data: calculateSummaryForMonth(new Date(new Date().setMonth(today.getMonth() - 1))) }]; container.innerHTML = summaries.map(s => `<div class="bg-blue-50 rounded-lg p-3"><h3 class="font-semibold mb-2">${s.title} ${s.data.days>0?`(${s.data.days} nap)`:""}</h3>${s.data.days>0?`<div class="grid grid-cols-2 gap-2 text-center text-sm"><div><div class="font-bold text-green-600">${formatDuration(s.data.workMinutes)}</div><div class="text-xs">Munka</div></div><div><div class="font-bold text-purple-600">${formatDuration(s.data.nightWorkMinutes)}</div><div class="text-xs">Éjszakai</div></div><div><div class="font-bold text-blue-700">${formatDuration(s.data.driveMinutes)}</div><div class="text-xs">Vezetés</div></div><div><div class="font-bold text-orange-600">${s.data.kmDriven} km</div><div class="text-xs">Táv</div></div></div>`:'<p class="text-center text-xs text-gray-500">Nincs adat</p>'}</div>`).join(''); };
        
        function navigateStats(direction) { if (statsView === 'daily') statsDate.setMonth(statsDate.getMonth() + direction); else if (statsView === 'monthly') statsDate.setFullYear(statsDate.getFullYear() + direction); else if (statsView === 'yearly') return; renderStats(); }
        function renderStats() {
            const periodDisplay = document.getElementById('stats-period-display');
            document.querySelectorAll('.stats-view-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`stats-view-${statsView}`).classList.add('active');
            let data;
            if (statsView === 'daily') {
                periodDisplay.textContent = `${statsDate.getFullYear()}. ${statsDate.toLocaleString('hu-HU', { month: 'long' })}`;
                data = getDailyData(statsDate);
            } else if (statsView === 'monthly') {
                periodDisplay.textContent = `${statsDate.getFullYear()}`;
                data = getMonthlyData(statsDate);
            } else { // yearly
                data = getYearlyData();
                periodDisplay.textContent = data.labels.length > 0 ? `${data.labels[0]} - ${data.labels[data.labels.length - 1]}` : 'Nincsenek adatok';
            }
            const noDataEl = document.getElementById('stats-no-data');
            const chartsContainer = document.getElementById('stats-charts-container');
            const hasData = data.datasets.work.some(d => d > 0) || data.datasets.km.some(d => d > 0);
            
            const totals = {
                work: data.datasets.work.reduce((a, b) => a + b, 0) * 60,
                drive: data.datasets.drive.reduce((a, b) => a + b, 0) * 60,
                night: data.datasets.night.reduce((a, b) => a + b, 0) * 60,
                km: data.datasets.km.reduce((a, b) => a + b, 0)
            };

            const workTotalEl = document.getElementById('workTimeTotal');
            const driveTotalEl = document.getElementById('driveTimeTotal');
            const nightTotalEl = document.getElementById('nightTimeTotal');
            const kmTotalEl = document.getElementById('kmTotal');
            
            workTotalEl.className = 'text-sm font-bold text-green-600';
            driveTotalEl.className = 'text-sm font-bold text-blue-600';
            nightTotalEl.className = 'text-sm font-bold text-purple-600';
            kmTotalEl.className = 'text-sm font-bold text-orange-600';
            
            if (!hasData) {
                noDataEl.classList.remove('hidden');
                chartsContainer.classList.add('hidden');
                workTotalEl.textContent = ''; driveTotalEl.textContent = ''; nightTotalEl.textContent = ''; kmTotalEl.textContent = '';
            } else {
                noDataEl.classList.add('hidden');
                chartsContainer.classList.remove('hidden');

                workTotalEl.textContent = formatDuration(totals.work);
                driveTotalEl.textContent = formatDuration(totals.drive);
                nightTotalEl.textContent = formatDuration(totals.night);
                kmTotalEl.textContent = `${Math.round(totals.km)} km`;

                workTimeChart = createOrUpdateBarChart(workTimeChart, 'workTimeChart', data.labels, data.datasets.work, 'Munkaidő (óra)', '#22c55e', (value) => `${value.toFixed(1)} ó`);
                driveTimeChart = createOrUpdateBarChart(driveTimeChart, 'driveTimeChart', data.labels, data.datasets.drive, 'Vezetés (óra)', '#3b82f6', (value) => `${value.toFixed(1)} ó`);
                nightTimeChart = createOrUpdateBarChart(nightTimeChart, 'nightTimeChart', data.labels, data.datasets.night, 'Éjszakai (óra)', '#8b5cf6', (value) => `${value.toFixed(1)} ó`);
                kmChart = createOrUpdateBarChart(kmChart, 'kmChart', data.labels, data.datasets.km, 'Távolság (km)', '#f97316', (value) => `${Math.round(value)} km`);
            }
        }
        function getDailyData(date) { const year = date.getFullYear(); const month = date.getMonth(); const daysInMonth = new Date(year, month + 1, 0).getDate(); const labels = Array.from({ length: daysInMonth }, (_, i) => String(i + 1)); const datasets = { work: Array(daysInMonth).fill(0), drive: Array(daysInMonth).fill(0), night: Array(daysInMonth).fill(0), km: Array(daysInMonth).fill(0) }; records.filter(r => r.date.startsWith(`${year}-${String(month + 1).padStart(2, '0')}`)).forEach(r => { const dayIndex = new Date(r.date + 'T00:00:00').getDate() - 1; datasets.work[dayIndex] += r.workMinutes / 60; datasets.drive[dayIndex] += r.driveMinutes / 60; datasets.night[dayIndex] += r.nightWorkMinutes / 60; datasets.km[dayIndex] += r.kmDriven; }); return { labels, datasets }; }
        function getMonthlyData(date) { const year = date.getFullYear(); const labels = ['Jan', 'Feb', 'Már', 'Ápr', 'Máj', 'Jún', 'Júl', 'Aug', 'Szep', 'Okt', 'Nov', 'Dec']; const datasets = { work: Array(12).fill(0), drive: Array(12).fill(0), night: Array(12).fill(0), km: Array(12).fill(0) }; records.filter(r => r.date.startsWith(year)).forEach(r => { const monthIndex = new Date(r.date + 'T00:00:00').getMonth(); datasets.work[monthIndex] += r.workMinutes / 60; datasets.drive[monthIndex] += r.driveMinutes / 60; datasets.night[monthIndex] += r.nightWorkMinutes / 60; datasets.km[monthIndex] += r.kmDriven; }); return { labels, datasets }; }
        function getYearlyData() { if (records.length === 0) return { labels: [], datasets: { work: [], drive: [], night: [], km: [] } }; const yearData = {}; records.forEach(r => { const year = r.date.substring(0, 4); if (!yearData[year]) yearData[year] = { work: 0, drive: 0, night: 0, km: 0 }; yearData[year].work += r.workMinutes / 60; yearData[year].drive += r.driveMinutes / 60; yearData[year].night += r.nightWorkMinutes / 60; yearData[year].km += r.kmDriven; }); const labels = Object.keys(yearData).sort(); const datasets = { work: [], drive: [], night: [], km: [] }; labels.forEach(year => { datasets.work.push(yearData[year].work); datasets.drive.push(yearData[year].drive); datasets.night.push(yearData[year].night); datasets.km.push(yearData[year].km); }); return { labels, datasets }; }
        function createOrUpdateBarChart(chartInstance, canvasId, labels, data, labelText, color, tooltipCallback) { const ctx = document.getElementById(canvasId).getContext('2d'); if (chartInstance) { chartInstance.destroy(); } return new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: labelText, data: data, backgroundColor: color, borderRadius: 4 }] }, options: { plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(context) { return tooltipCallback(context.parsed.y); } } } }, scales: { y: { beginAtZero: true } } } }); }
        
        const toISODate = d => d.toISOString().split('T')[0];
        function calculateSummary(filterFn) { return (records || []).filter(filterFn).reduce((acc, r) => ({ workMinutes: acc.workMinutes + (r.workMinutes || 0), nightWorkMinutes: acc.nightWorkMinutes + (r.nightWorkMinutes || 0), driveMinutes: acc.driveMinutes + (r.driveMinutes || 0), kmDriven: acc.kmDriven + (r.kmDriven || 0), days: acc.days + 1 }), { workMinutes: 0, nightWorkMinutes: 0, driveMinutes: 0, kmDriven: 0, days: 0 }); }
        function calculateSummaryForDate(date) { const dateStr = toISODate(date); return calculateSummary(r => r.date === dateStr); }
        function calculateSummaryForDateRange({ start, end }) { const startStr = toISODate(start); const endStr = toISODate(end); return calculateSummary(r => r.date >= startStr && r.date <= endStr); }
        function calculateSummaryForMonth(date) { const monthStr = date.toISOString().slice(0, 7); return calculateSummary(r => r.date.startsWith(monthStr)); }
        function getWeekRange(date, offset = 0) { const d = new Date(date); d.setDate(d.getDate() + (offset * 7)); const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1); const start = new Date(d.setDate(diff)); const end = new Date(start); end.setDate(start.getDate() + 6); return { start, end }; }
        
        let currentMonthlyData = null;
        function initMonthlyReport() { 
            document.getElementById('monthSelector').value = new Date().toISOString().slice(0, 7); 
            document.getElementById('monthlyReportContent').innerHTML = ''; 
            document.getElementById('pdfExportBtn').classList.add('hidden'); 
            document.getElementById('pdfShareBtn').classList.add('hidden');
        }
        function generateMonthlyReport() { 
            const selectedMonth = document.getElementById("monthSelector").value; 
            const monthRecords = records.filter(record => record.date.startsWith(selectedMonth)); 
            monthRecords.sort((a, b) => new Date(a.date) - new Date(b.date)); 
            const [year, month] = selectedMonth.split('-'); 
            const germanMonths = ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember']; 
            const monthName = germanMonths[parseInt(month) - 1]; 
            currentMonthlyData = { month: `${monthName} ${year}`, records: monthRecords }; 
            const reportHTML = `<div class="bg-white p-4 text-xs">A PDF exportálás mostantól egy részletesebb, a hónap minden napját tartalmazó formátumot használ.</div>`; 
            document.getElementById('monthlyReportContent').innerHTML = reportHTML; 
            document.getElementById('pdfExportBtn').classList.remove('hidden');
            if (navigator.share) {
                document.getElementById('pdfShareBtn').classList.remove('hidden');
            }
        }
        const germanDays = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa']; 
        function formatTimeGerman(b) { const c = Math.floor(b / 60), d = b % 60; return `${c.toString().padStart(2,"0")}:${d.toString().padStart(2,"0")}` } 
        function formatDateGerman(dateObj) { if (!(dateObj instanceof Date) || isNaN(dateObj)) return 'Hibás Dátum'; const d = dateObj.getUTCDate().toString().padStart(2, "0"), e = (dateObj.getUTCMonth() + 1).toString().padStart(2, "0"), f = dateObj.getUTCFullYear(), g = germanDays[dateObj.getUTCDay()]; return `${g}, ${d}.${e}.${f}` }
        
        function exportToPDF() {
            try {
                if (!currentMonthlyData) {
                    alert("Először generálj riportot!");
                    return;
                }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const userName = document.getElementById('userNameInput').value || '';

                const [monthName, yearStr] = currentMonthlyData.month.split(' ');
                const year = parseInt(yearStr);
                const germanMonths = ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
                const month = germanMonths.indexOf(monthName);
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const germanFullDays = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];

                const recordsMap = new Map(currentMonthlyData.records.map(r => [r.date, r]));

                let totalWorkMinutes = 0;
                let totalNightWorkMinutes = 0;
                recordsMap.forEach(record => {
                    totalWorkMinutes += record.workMinutes || 0;
                    totalNightWorkMinutes += record.nightWorkMinutes || 0;
                });

                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('ARBEITSZEIT-NACHWEIS', 105, 15, { align: 'center' });
                doc.setFontSize(14);
                doc.setFont(undefined, 'normal');
                doc.text(currentMonthlyData.month, 105, 23, { align: 'center' });
                if (userName) {
                    doc.setFontSize(12);
                    doc.text(userName, 105, 31, { align: 'center' });
                }

                let yPos = 40;
                const pageBottom = 280;
                const leftMargin = 15;
                const tableWidth = 180;
                const headers = ['Datum', 'Beginn/Ort', 'Ende/Ort', 'Arbeit', 'Nacht', 'Fahrt', 'km'];
                const colWidths = [30, 37, 37, 18, 18, 18, 17];

                const drawHeader = () => {
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.setFillColor(230, 230, 230);
                    let xPos = leftMargin;
                    headers.forEach((h, i) => {
                        doc.rect(xPos, yPos, colWidths[i], 7, 'F');
                        doc.text(h, xPos + colWidths[i] / 2, yPos + 4.5, { align: 'center' });
                        xPos += colWidths[i];
                    });
                    yPos += 7;
                    doc.setFont(undefined, 'normal');
                };

                drawHeader();

                for (let day = 1; day <= daysInMonth; day++) {
                    const currentDate = new Date(Date.UTC(year, month, day));
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const dayOfWeek = currentDate.getUTCDay();
                    const record = recordsMap.get(dateStr);
                    
                    const rowHeight = 12;

                    const potentialBlockHeight = record && record.crossings && record.crossings.length > 0 ? rowHeight + 8 : rowHeight;
                    if (yPos + potentialBlockHeight > pageBottom) {
                        doc.addPage();
                        yPos = 20;
                        drawHeader();
                    }
                    
                    const dateDisplay = `${String(day).padStart(2, '0')}.${String(month + 1).padStart(2, '0')}.${year}`;
                    const dayNameDisplay = germanFullDays[dayOfWeek];
                    const dateCellText = `${dateDisplay}\n${dayNameDisplay}`;
                    const rowData = record ? [
                        dateCellText, `${record.startTime}\n${record.startLocation||"-"}`, `${record.endTime}\n${record.endLocation||"-"}`,
                        formatTimeGerman(record.workMinutes), formatTimeGerman(record.nightWorkMinutes || 0),
                        formatTimeGerman(record.driveMinutes), String(record.kmDriven || 0)
                    ] : [dateCellText, '-', '-', '-', '-', '-', '-'];
                    
                    let xPos = leftMargin;
                    
                    rowData.forEach((data, i) => {
                        doc.setFillColor(255, 255, 255);
                        if (i === 0) {
                            if (dayOfWeek === 6) doc.setFillColor(245, 245, 245);
                            if (dayOfWeek === 0) doc.setFillColor(220, 220, 220);
                        }
                        
                        doc.setDrawColor(150, 150, 150);
                        doc.rect(xPos, yPos, colWidths[i], rowHeight, 'FD');
                        doc.setFontSize(8);
                        doc.text(data, xPos + colWidths[i] / 2, yPos + 4.5, { align: 'center' });
                        xPos += colWidths[i];
                    });
                    yPos += rowHeight;

                    if (record && record.crossings && record.crossings.length > 0) {
                        const crossingsText = `Grenzübergänge: ${record.crossings.map(c => `${c.from}-${c.to} (${c.time})`).join(", ")}`;
                        const crossingLines = doc.splitTextToSize(crossingsText, tableWidth - 4);
                        const crossingsRowHeight = crossingLines.length * 3.5 + 2;

                        doc.setFillColor(239, 246, 255);
                        doc.rect(leftMargin, yPos, tableWidth, crossingsRowHeight, 'F');
                        
                        doc.setFontSize(7);
                        doc.setFont(undefined, 'italic');
                        doc.text(crossingLines, leftMargin + 2, yPos + 1.5, { baseline: 'top' });
                        yPos += crossingsRowHeight;
                        doc.setFont(undefined, 'normal');
                    }
                }
                
                yPos += 5;
                if (yPos > pageBottom - 20) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                const workTotalStr = formatTimeGerman(totalWorkMinutes);
                const nightTotalStr = formatTimeGerman(totalNightWorkMinutes);

                doc.text(`Gesamt Arbeitszeit: ${workTotalStr}`, leftMargin + tableWidth, yPos, { align: 'right' });
                yPos += 6;
                doc.text(`Gesamt Nachtzeit: ${nightTotalStr}`, leftMargin + tableWidth, yPos, { align: 'right' });

                doc.save(`Arbeitszeit-${userName.replace(/ /g,"_")}-${currentMonthlyData.month}.pdf`);
            } catch (e) {
                console.error("PDF generálási hiba:", e);
                alert("Hiba történt a PDF generálása közben: " + e.message);
            }
        }
        async function sharePDF() {
            if (!currentMonthlyData) { showCustomAlert("Először generálj riportot a megosztáshoz!", "info"); return; }
            if (!navigator.share) { showCustomAlert("A böngésződ nem támogatja ezt a funkciót.", "info"); return; }
            try {
                // A PDF generálás itt történik, ugyanúgy mint az exportToPDF-ben, de a végén blob-ként adjuk vissza
                // Ez a kódblokk duplikált, de a jsPDF objektum lokális hatóköre miatt szükséges
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const userName = document.getElementById('userNameInput').value || '';
                const [monthName, yearStr] = currentMonthlyData.month.split(' ');
                const year = parseInt(yearStr);
                const germanMonths = ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
                const month = germanMonths.indexOf(monthName);
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const germanFullDays = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
                const recordsMap = new Map(currentMonthlyData.records.map(r => [r.date, r]));
                let totalWorkMinutes = 0;
                let totalNightWorkMinutes = 0;
                recordsMap.forEach(record => {
                    totalWorkMinutes += record.workMinutes || 0;
                    totalNightWorkMinutes += record.nightWorkMinutes || 0;
                });
                doc.setFontSize(18); doc.setFont(undefined, 'bold'); doc.text('ARBEITSZEIT-NACHWEIS', 105, 15, { align: 'center' }); doc.setFontSize(14); doc.setFont(undefined, 'normal'); doc.text(currentMonthlyData.month, 105, 23, { align: 'center' }); if (userName) { doc.setFontSize(12); doc.text(userName, 105, 31, { align: 'center' }); }
                let yPos = 40; const pageBottom = 280; const leftMargin = 15; const tableWidth = 180; const headers = ['Datum', 'Beginn/Ort', 'Ende/Ort', 'Arbeit', 'Nacht', 'Fahrt', 'km']; const colWidths = [30, 37, 37, 18, 18, 18, 17];
                const drawHeader = () => { doc.setFontSize(9); doc.setFont(undefined, 'bold'); doc.setFillColor(230, 230, 230); let xPos = leftMargin; headers.forEach((h, i) => { doc.rect(xPos, yPos, colWidths[i], 7, 'F'); doc.text(h, xPos + colWidths[i] / 2, yPos + 4.5, { align: 'center' }); xPos += colWidths[i]; }); yPos += 7; doc.setFont(undefined, 'normal'); };
                drawHeader();
                for (let day = 1; day <= daysInMonth; day++) {
                    const currentDate = new Date(Date.UTC(year, month, day)); const dateStr = currentDate.toISOString().split('T')[0]; const dayOfWeek = currentDate.getUTCDay(); const record = recordsMap.get(dateStr); const rowHeight = 12;
                    const potentialBlockHeight = record && record.crossings && record.crossings.length > 0 ? rowHeight + 8 : rowHeight;
                    if (yPos + potentialBlockHeight > pageBottom) { doc.addPage(); yPos = 20; drawHeader(); }
                    const dateDisplay = `${String(day).padStart(2, '0')}.${String(month + 1).padStart(2, '0')}.${year}`; const dayNameDisplay = germanFullDays[dayOfWeek]; const dateCellText = `${dateDisplay}\n${dayNameDisplay}`;
                    const rowData = record ? [dateCellText, `${record.startTime}\n${record.startLocation||"-"}`, `${record.endTime}\n${record.endLocation||"-"}`, formatTimeGerman(record.workMinutes), formatTimeGerman(record.nightWorkMinutes || 0), formatTimeGerman(record.driveMinutes), String(record.kmDriven || 0)] : [dateCellText, '-', '-', '-', '-', '-', '-'];
                    let xPos = leftMargin;
                    rowData.forEach((data, i) => {
                        doc.setFillColor(255, 255, 255);
                        if (i === 0) { if (dayOfWeek === 6) doc.setFillColor(245, 245, 245); if (dayOfWeek === 0) doc.setFillColor(220, 220, 220); }
                        doc.setDrawColor(150, 150, 150); doc.rect(xPos, yPos, colWidths[i], rowHeight, 'FD'); doc.setFontSize(8); doc.text(data, xPos + colWidths[i] / 2, yPos + 4.5, { align: 'center' }); xPos += colWidths[i];
                    });
                    yPos += rowHeight;
                    if (record && record.crossings && record.crossings.length > 0) {
                        const crossingsText = `Grenzübergänge: ${record.crossings.map(c => `${c.from}-${c.to} (${c.time})`).join(", ")}`; const crossingLines = doc.splitTextToSize(crossingsText, tableWidth - 4); const crossingsRowHeight = crossingLines.length * 3.5 + 2;
                        doc.setFillColor(239, 246, 255); doc.rect(leftMargin, yPos, tableWidth, crossingsRowHeight, 'F');
                        doc.setFontSize(7); doc.setFont(undefined, 'italic'); doc.text(crossingLines, leftMargin + 2, yPos + 1.5, { baseline: 'top' }); yPos += crossingsRowHeight; doc.setFont(undefined, 'normal');
                    }
                }
                yPos += 5; if (yPos > pageBottom - 20) { doc.addPage(); yPos = 20; }
                doc.setFontSize(10); doc.setFont(undefined, 'bold'); const workTotalStr = formatTimeGerman(totalWorkMinutes); const nightTotalStr = formatTimeGerman(totalNightWorkMinutes);
                doc.text(`Gesamt Arbeitszeit: ${workTotalStr}`, leftMargin + tableWidth, yPos, { align: 'right' }); yPos += 6; doc.text(`Gesamt Nachtzeit: ${nightTotalStr}`, leftMargin + tableWidth, yPos, { align: 'right' });
                
                const pdfBlob = doc.output('blob');
                const fileName = `Arbeitszeit-${userName.replace(/ /g,"_")}-${currentMonthlyData.month}.pdf`;
                const pdfFile = new File([pdfBlob], fileName, { type: 'application/pdf' });
                const shareData = { files: [pdfFile], title: `Munkaidő Riport - ${currentMonthlyData.month}`, text: `Csatolva a(z) ${currentMonthlyData.month} havi munkaidő riportom.`, };
                if (navigator.canShare && navigator.canShare(shareData)) {
                    await navigator.share(shareData);
                } else { throw new Error('Ezt a fájlt nem lehet megosztani.'); }
            } catch (error) {
                if (error.name === 'AbortError') { console.log('Megosztás megszakítva.'); } 
                else { console.error('Hiba a megosztás során:', error); showCustomAlert(`Hiba a megosztás során: ${error.message}`, 'info'); }
            }
        }
        function saveSettings() { localStorage.setItem('userName', document.getElementById('userNameInput').value); showCustomAlert('Beállítások mentve!', 'success'); }
        function loadSettings() { 
            document.getElementById('userNameInput').value = localStorage.getItem('userName') || ''; 
            document.getElementById('themeSelector').value = localStorage.getItem('theme') || 'auto'; 
            document.getElementById('autoExportSelector').value = localStorage.getItem('autoExportFrequency') || 'never'; 
        }
        function exportData() { if (records.length === 0) { showCustomAlert('Nincsenek adatok az exportáláshoz!', 'info'); return; } const dataStr = JSON.stringify(records, null, 2); const blob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `munkaido_backup_${new Date().toISOString().split("T")[0]}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
        function importData() { const fileInput = document.getElementById('importFile'); if (!fileInput.files.length) { showCustomAlert('Kérlek válassz egy fájlt!', 'info'); return; } if (!confirm('Biztosan importálod? A jelenlegi adatok felülíródnak!')) return; const reader = new FileReader(); reader.onload = function(e) { try { const imported = JSON.parse(e.target.result); if (Array.isArray(imported)) { records = imported; if(currentUser) { migrateLocalToFirestore(records); } else { localStorage.setItem('workRecords', JSON.stringify(records)); } renderApp(); showCustomAlert('Adatok sikeresen importálva!', 'success'); } else { throw new Error('Érvénytelen formátum.'); } } catch (err) { showCustomAlert('Hiba: ' + err.message, 'info'); } }; reader.readAsText(fileInput.files[0]); }
        function applyTheme(theme) { if (theme === 'dark') { document.documentElement.classList.add('dark'); } else if (theme === 'light') { document.documentElement.classList.remove('dark'); } else { if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) { document.documentElement.classList.add('dark'); } else { document.documentElement.classList.remove('dark'); } } }
        function setTheme(theme) { applyTheme(theme); localStorage.setItem('theme', theme); }
        function initTheme() { const savedTheme = localStorage.getItem('theme') || 'auto'; applyTheme(savedTheme); window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => { if(localStorage.getItem('theme') === 'auto') { applyTheme('auto'); } }); }
        function initSassiMode() {
            const toggle = document.getElementById('sassiModeToggle');
            const compGroup = document.getElementById('compensation-group');
            const label = document.getElementById('sassiModeLabel');
            if (!toggle || !compGroup || !label) return;
            const checkmark = label.querySelector('.sassi-checkmark');

            const updateSassiModeUI = (isEnabled) => {
                label.classList.remove('bg-green-100', 'dark:bg-green-800/50', 'font-semibold', 'bg-blue-50', 'dark:bg-blue-900/50');
                if (isEnabled) {
                    label.classList.add('bg-green-100', 'dark:bg-green-800/50', 'font-semibold');
                    if (checkmark) checkmark.classList.remove('hidden');
                } else {
                    label.classList.add('bg-blue-50', 'dark:bg-blue-900/50');
                    if (checkmark) checkmark.classList.add('hidden');
                }
                
                if (isEnabled) {
                    compGroup.classList.remove('hidden');
                } else {
                    compGroup.classList.add('hidden');
                    document.getElementById('compensationTime').value = '';
                }
            };

            const isEnabled = localStorage.getItem('sassiModeEnabled') === 'true';
            toggle.checked = isEnabled;
            updateSassiModeUI(isEnabled);

            toggle.addEventListener('change', (e) => {
                const enabled = e.target.checked;
                localStorage.setItem('sassiModeEnabled', enabled);
                updateSassiModeUI(enabled);
            });
        }
        function updateUniqueLocations() { const locations = new Set(); (records || []).forEach(r => { if (r.startLocation) locations.add(r.startLocation); if (r.endLocation) locations.add(r.endLocation); }); uniqueLocations = Array.from(locations).sort(); }
        function initAutocomplete(input) { if (!input) return; input.addEventListener('input', function() { const val = this.value; hideAutocomplete(); if (!val) return; const suggestions = document.createElement('div'); suggestions.id = 'autocomplete-list'; suggestions.className = 'autocomplete-list absolute z-20 w-full border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto bg-white'; suggestions.style.top = (this.offsetHeight + 12) + 'px'; const filteredLocations = uniqueLocations.filter(loc => loc.toLowerCase().includes(val.toLowerCase())); filteredLocations.forEach(loc => { const item = document.createElement('div'); item.innerHTML = loc.replace(new RegExp(val, 'gi'), '<strong>$&</strong>'); item.className = 'p-2 hover:bg-gray-100 cursor-pointer autocomplete-item'; item.addEventListener('click', () => { input.value = loc; hideAutocomplete(); }); suggestions.appendChild(item); }); if(filteredLocations.length > 0) this.parentNode.appendChild(suggestions); }); }
        function initAllAutocomplete() { initAutocomplete(document.getElementById('liveStartLocation')); initAutocomplete(document.getElementById('startLocation')); initAutocomplete(document.getElementById('endLocation')); }
        function hideAutocomplete() { document.querySelectorAll('#autocomplete-list').forEach(list => list.remove()); }
        function calculateWorkMinutes(start, end) { if (!start || !end) return 0; const s = new Date(`2000-01-01T${start}`); let e = new Date(`2000-01-01T${end}`); if (e < s) e.setDate(e.getDate() + 1); return Math.floor((e - s) / 60000); }
        function calculateNightWorkMinutes(startTime, endTime) { if (!startTime || !endTime) return 0; const start = new Date(`1970-01-01T${startTime}`); let end = new Date(`1970-01-01T${endTime}`); if (end <= start) end.setDate(end.getDate() + 1); let nightMinutes = 0; let current = new Date(start); while (current < end) { const hour = current.getHours(); if (hour >= 22 || hour < 6) { nightMinutes++; } current.setMinutes(current.getMinutes() + 1); } return nightMinutes; }
        function parseTimeToMinutes(timeStr) { if (!timeStr || !timeStr.includes(':')) return 0; const p = timeStr.split(':'); if (p.length !== 2) return 0; return parseInt(p[0], 10) * 60 + parseInt(p[1], 10); }
        function formatDuration(minutes) { const h = Math.floor(minutes / 60); const m = Math.round(minutes % 60); return `${h}ó ${m}p`; }
        function formatTimeInput(inputElement, allowHoursOver24 = false) { let value = inputElement.value.replace(/[^0-9]/g, ''); if (value.length < 3) return; if (value.length === 3 && !allowHoursOver24) value = '0' + value; const hours = parseInt(value.substring(0, value.length - 2), 10); const minutes = parseInt(value.substring(value.length - 2), 10); if (minutes >= 0 && minutes <= 59 && hours >= 0 && (allowHoursOver24 || hours <= 23)) { inputElement.value = `${String(hours).padStart(2,"0")}:${String(minutes).padStart(2,"0")}`; } else { inputElement.value = ''; } updateDisplays(); }
        function checkForAutoExport() {
            const frequency = localStorage.getItem('autoExportFrequency') || 'never';
            if (frequency === 'never' || records.length === 0) { return; }
            const lastExportDateStr = localStorage.getItem('lastAutoExportDate');
            if (!lastExportDateStr) { return; }
            const lastExportDate = new Date(lastExportDateStr);
            const today = new Date();
            const diffTime = today - lastExportDate;
            let requiredInterval = 0;
            switch(frequency) {
                case 'daily':   requiredInterval = 24 * 60 * 60 * 1000; break;
                case 'weekly':  requiredInterval = 7 * 24 * 60 * 60 * 1000; break;
                case 'monthly': requiredInterval = 30 * 24 * 60 * 60 * 1000; break;
            }
            if (diffTime > requiredInterval) {
                console.log(`Automatikus mentés (${frequency}) elindítva...`);
                exportData();
                localStorage.setItem('lastAutoExportDate', new Date().toISOString());
            }
        }

        // =======================================================
        // ===== TACHOGRÁF ELEMZŐ MODUL (v6.12) ==================
        // =======================================================
        
        function calculateRestDebt() {
            let totalDebtMinutes = 0;
            const sortedRecords = [...records].sort((a, b) => new Date(`${a.date}T${a.startTime}`) - new Date(`${b.date}T${b.startTime}`));
            if (sortedRecords.length < 2) return 0;

            const weeklyRestData = getWeeklyRestData();

            for (let i = 1; i < sortedRecords.length; i++) {
                const currentRecord = sortedRecords[i];
                const prevEnd = new Date(`${sortedRecords[i-1].date}T${sortedRecords[i-1].endTime}`);
                const currentStart = new Date(`${currentRecord.date}T${currentRecord.startTime}`);
                const restDurationMinutes = Math.round((currentStart - prevEnd) / 60000);

                if (weeklyRestData[currentRecord.id] && restDurationMinutes >= (24 * 60) && restDurationMinutes < (45 * 60)) {
                    totalDebtMinutes += (45 * 60) - restDurationMinutes;
                }
            }
            return totalDebtMinutes;
        }

        function calculateWeeklyAllowance() {
            const now = new Date();
            const { start, end } = getWeekRange(now);
            const startStr = toISODate(start);
            const endStr = toISODate(end);
            const recordsInWeek = records.filter(r => r.date >= startStr && r.date <= endStr);
            const extendedDrivesThisWeek = recordsInWeek.filter(r => r.driveMinutes > 540).length;
            const remainingDrives = Math.max(0, 2 - extendedDrivesThisWeek);
            let reducedRestsInCycle = 0;
            const sortedRecords = [...records].sort((a, b) => new Date(`${a.date}T${a.startTime}`) - new Date(`${b.date}T${b.startTime}`));
            for (let i = sortedRecords.length - 1; i > 0; i--) {
                const currentRecord = sortedRecords[i];
                const previousRecord = sortedRecords[i-1];
                const prevEnd = new Date(`${previousRecord.date}T${previousRecord.endTime}`);
                const currentStart = new Date(`${currentRecord.date}T${currentRecord.startTime}`);
                const restDurationHours = Math.round((currentStart - prevEnd) / 60000) / 60;
                if (restDurationHours >= 24) { break; }
                const isSplitRest = getSplitRestData()[previousRecord.id] === true;
                if (isSplitRest) continue;
                const prevWorkDurationHours = previousRecord.workMinutes / 60;
                const isForcedReduced = prevWorkDurationHours > 13;
                if ((restDurationHours >= 9 && restDurationHours < 11) || isForcedReduced) {
                    reducedRestsInCycle++;
                }
            }
            const remainingRests = Math.max(0, 3 - reducedRestsInCycle);
            return { remainingDrives, remainingRests };
        }

        function renderWeeklyAllowance() {
            const liveContainer = document.getElementById('live-allowance-display');
            const tachoContainer = document.getElementById('tacho-allowance-display');
            if (!liveContainer || !tachoContainer) return;

            const allowance = calculateWeeklyAllowance();
            const debtMinutes = calculateRestDebt();
            const debtHTML = debtMinutes > 0 ? `
                <div class="p-2 bg-red-50 dark:bg-red-600/20 rounded-lg border border-red-200 dark:border-red-800">
                    <p class="text-sm font-medium text-red-800 dark:text-red-200">Kompenzáció</p>
                    <p class="text-2xl font-bold text-red-600 dark:text-red-400">${formatDuration(debtMinutes)}</p>
                </div>` : '';

            const html = `
            <div class="grid ${debtMinutes > 0 ? 'grid-cols-3' : 'grid-cols-2'} gap-2 text-center">
                <div class="p-2 bg-blue-50 dark:bg-blue-600/20 rounded-lg border border-blue-200 dark:border-blue-800">
                    <p class="text-sm font-medium text-blue-800 dark:text-blue-200">Felh. 10ó vezetés</p>
                    <p class="text-2xl font-bold text-blue-600 dark:text-blue-400">${allowance.remainingDrives}</p>
                </div>
                <div class="p-2 bg-orange-50 dark:bg-orange-600/20 rounded-lg border border-orange-200 dark:border-orange-800">
                    <p class="text-sm font-medium text-orange-800 dark:text-orange-200">Felh. csökk. pihenő</p>
                    <p class="text-2xl font-bold text-orange-600 dark:text-orange-400">${allowance.remainingRests}</p>
                </div>
                ${debtHTML}
            </div>`;

            liveContainer.innerHTML = html.replace(/text-2xl/g, 'text-xl').replace(/<p class="text-sm/g, '<p class="text-xs');
            tachoContainer.innerHTML = html;
        }

        function getWeekIdentifier(d) {
            const date = new Date(d.valueOf());
            date.setHours(0, 0, 0, 0);
            date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
            const week1 = new Date(date.getFullYear(), 0, 4);
            return date.getFullYear() + '-' + (1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7));
        }

        function getSplitRestData() { return JSON.parse(localStorage.getItem('splitRestData') || '{}'); }
        function saveSplitRestData(data) { localStorage.setItem('splitRestData', JSON.stringify(data)); }
        function getWeeklyRestData() { return JSON.parse(localStorage.getItem('weeklyRestData') || '{}'); }
        function saveWeeklyRestData(data) { localStorage.setItem('weeklyRestData', JSON.stringify(data)); }

        function handleTachographToggle(checkbox, recordId, type) {
            const data = type === 'split' ? getSplitRestData() : getWeeklyRestData();
            if (checkbox.checked) { data[recordId] = true; } else { delete data[recordId]; }
            if (type === 'split') saveSplitRestData(data); else saveWeeklyRestData(data);
            renderTachographAnalysis();
            renderWeeklyAllowance();
        }

        function renderTachographAnalysis() {
            const container = document.getElementById('tachograph-list');
            if (!container) return;
            const sortedRecords = [...records].sort((a, b) => new Date(`${a.date}T${a.startTime}`) - new Date(`${b.date}T${b.startTime}`));
            if (sortedRecords.length < 1) { container.innerHTML = '<p class="text-center text-gray-500 py-8">Nincsenek bejegyzések az elemzéshez.</p>'; return; }

            const splitRestData = getSplitRestData();
            const weeklyRestData = getWeeklyRestData();
            let analysisResults = [];
            let reducedDailyRestCounter = 0;
            let extendedDrivingInWeekCounter = {};

            for (let i = 0; i < sortedRecords.length; i++) {
                const currentRecord = sortedRecords[i];
                const previousRecord = i > 0 ? sortedRecords[i-1] : null;
                let restAnalysis = { text: 'Első rögzített nap', colorClass: 'bg-gray-200 text-gray-800', duration: 0 };
                
                if (previousRecord) {
                    const prevEnd = new Date(`${previousRecord.date}T${previousRecord.endTime}`);
                    const currentStart = new Date(`${currentRecord.date}T${currentRecord.startTime}`);
                    const restDurationMinutes = Math.round((currentStart - prevEnd) / 60000);
                    restAnalysis.duration = restDurationMinutes;
                    const restDurationHours = restDurationMinutes / 60;
                    const isSplitRest = splitRestData[previousRecord.id] === true;
                    const isMarkedAsWeekly = weeklyRestData[currentRecord.id] === true;
                    const prevWorkDurationHours = previousRecord.workMinutes / 60;

                    if (restDurationHours >= 24) {
                        reducedDailyRestCounter = 0;
                        if (isMarkedAsWeekly) {
                            if (restDurationHours >= 45) {
                                restAnalysis = { text: `Rendes heti pihenő (${formatDuration(restDurationMinutes)})`, colorClass: 'bg-green-700 text-white' };
                            } else {
                                restAnalysis = { text: `Csökkentett heti pihenő (${formatDuration(restDurationMinutes)})`, colorClass: 'bg-green-700 text-white' };
                            }
                        } else {
                             restAnalysis = { text: `Hosszú pihenő (${formatDuration(restDurationMinutes)})`, colorClass: 'bg-gray-300 text-gray-800' };
                        }
                    } else if (restDurationHours < 9) {
                        restAnalysis = { text: `Szabálytalan pihenő (${formatDuration(restDurationMinutes)})`, colorClass: 'bg-red-500 text-white' };
                    } else if (isSplitRest) {
                        restAnalysis = { text: `Osztott pihenő (${formatDuration(restDurationMinutes)})`, colorClass: 'bg-green-200 text-green-800' };
                    } else if (restDurationHours >= 11 && prevWorkDurationHours <= 13) {
                        restAnalysis = { text: `Rendes napi pihenő (${formatDuration(restDurationMinutes)})`, colorClass: 'bg-green-500 text-white' };
                    } else {
                        reducedDailyRestCounter++;
                        const isForcedReduced = prevWorkDurationHours > 13;
                        const reason = isForcedReduced ? ` (13ó+ munka miatt)` : '';
                        let colorClass, countText;
                        switch(reducedDailyRestCounter) {
                            case 1: colorClass = 'bg-yellow-200 text-yellow-800'; countText = '1.'; break;
                            case 2: colorClass = 'bg-yellow-400 text-black'; countText = '2.'; break;
                            case 3: colorClass = 'bg-orange-400 text-black'; countText = '3.'; break;
                            default: colorClass = 'bg-red-500 text-white'; countText = `${reducedDailyRestCounter}.`; break;
                        }
                        restAnalysis = { text: `${countText} csökkentett napi pihenő${reason} (${formatDuration(restDurationMinutes)})`, colorClass: colorClass };
                    }
                }

                let driveAnalysis;
                const driveHours = currentRecord.driveMinutes / 60;
                if (driveHours > 10) {
                    driveAnalysis = { text: `Szabálytalan vezetés (${formatDuration(currentRecord.driveMinutes)})`, colorClass: 'bg-red-500 text-white' };
                } else if (driveHours > 9) {
                    const weekId = getWeekIdentifier(new Date(currentRecord.date));
                    extendedDrivingInWeekCounter[weekId] = (extendedDrivingInWeekCounter[weekId] || 0) + 1;
                    const countInWeek = extendedDrivingInWeekCounter[weekId];
                    driveAnalysis = { text: `${countInWeek}. ${countInWeek > 2 ? '(szabálytalan) ' : ''}megnövelt vezetés (${formatDuration(currentRecord.driveMinutes)})`, colorClass: countInWeek > 2 ? 'bg-red-500 text-white' : 'bg-blue-400 text-white' };
                } else {
                    driveAnalysis = { text: `Normál napi vezetés (${formatDuration(currentRecord.driveMinutes)})`, colorClass: 'bg-gray-300 text-gray-800' };
                }
                analysisResults.push({ record: currentRecord, rest: restAnalysis, drive: driveAnalysis, isSplit: splitRestData[currentRecord.id] === true, isWeekly: weeklyRestData[currentRecord.id] === true });
            }

            container.innerHTML = analysisResults.reverse().map(res => {
                const d = new Date(res.record.date + 'T00:00:00');
                const dateString = d.toLocaleDateString('hu-HU', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
                const isSplitActiveClass = res.isSplit ? 'bg-green-200 dark:bg-green-800 font-semibold' : 'hover:bg-gray-200 dark:hover:bg-gray-700';
                const checkmark = res.isSplit ? '<span class="font-bold text-lg">✓</span>' : '';
                
                let weeklyRestCheckboxHTML = '';
                if (res.rest.duration >= (24 * 60)) {
                    weeklyRestCheckboxHTML = `
                        <label for="weekly-${res.record.id}" class="flex items-center gap-2 cursor-pointer text-xs p-1 rounded-md ${res.isWeekly ? 'bg-green-200 dark:bg-green-800' : 'bg-gray-200 dark:bg-gray-600'}">
                           <input type="checkbox" id="weekly-${res.record.id}" onchange="handleTachographToggle(this, '${res.record.id}', 'weekly')" ${res.isWeekly ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                           <span class="text-gray-700 dark:text-gray-200">Heti pihenő volt?</span>
                        </label>`;
                }

                return `
                <div class="bg-white dark:bg-gray-800 rounded-lg p-3 shadow-sm border-l-4 ${res.rest.colorClass.replace('bg-', 'border-').replace(/ text-\w+-?\d*/g, '')}">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <p class="font-bold text-base text-gray-800 dark:text-gray-100">${dateString}</p>
                            ${weeklyRestCheckboxHTML}
                        </div>
                        <label for="split-${res.record.id}" class="flex items-center gap-2 cursor-pointer p-2 rounded-lg transition-colors ${isSplitActiveClass}">
                           <input type="checkbox" id="split-${res.record.id}" onchange="handleTachographToggle(this, '${res.record.id}', 'split')" ${res.isSplit ? 'checked' : ''} class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                           <span class="text-sm text-gray-700 dark:text-gray-200">Osztott pihenő ${checkmark}</span>
                        </label>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                        <div class="p-2 rounded ${res.rest.colorClass}">
                            <p class="font-semibold">Műszak előtti pihenő</p>
                            <p>${res.rest.text}</p>
                        </div>
                        <div class="p-2 rounded ${res.drive.colorClass}">
                            <p class="font-semibold">Napi vezetési idő</p>
                            <p>${res.drive.text}</p>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
    </script>
</body>
</html>