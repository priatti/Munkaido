<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Munkaidő Nyilvántartó Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        *,::before,::after{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::before,::after{--tw-content:''}html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}h1,h2,h3,h4,p,button,input,select{margin:0}h1,h2,h3,h4{font-size:inherit;font-weight:inherit}button,select{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;color:inherit;padding:0;text-transform:none}button{background-color:transparent;background-image:none;cursor:pointer}button:focus-visible{outline:2px solid transparent;outline-offset:2px}button:-moz-focusring{outline:auto}select{padding:0.5rem 2.5rem 0.5rem 0.75rem;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");background-position:right .5rem center;background-repeat:no-repeat;background-size:1.5em 1.5em}input,button,select{-webkit-appearance:none;-moz-appearance:none;appearance:none}input:not([type=button]):not([type=reset]):not([type=submit]){border-radius:0}input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{height:auto}input[type=search]{-webkit-appearance:textfield;outline-offset:-2px}input[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}svg,canvas{display:block;vertical-align:middle}
        .tab{flex:1 1 0%;padding:.75rem 1rem;text-align:center;font-size:.75rem;color:#4b5563;border-bottom-width:2px;border-color:transparent}@media (min-width: 600px){.tab{font-size:.875rem}}.tab-active{font-weight:600;color:#2563eb;background-color:#fff;border-color:#2563eb}.btn-primary{background-color:#3b82f6;color:#fff;padding:.5rem 1rem;border-radius:.5rem}.btn-primary:hover{background-color:#2563eb}.btn-secondary{background-color:#6b7280;color:#fff;padding:.5rem 1rem;border-radius:.5rem}.btn-secondary:hover{background-color:#4b5563}.input-group{display:flex;align-items:center;gap:.5rem}.dropdown-content{position:absolute;right:0;margin-top:.5rem;width:16rem;background-color:#f3f4f6;border-radius:.5rem;padding:.5rem;z-index:10;--tw-shadow:0 20px 25px -5px #0000001a, 0 8px 10px -6px #0000001a;--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color), 0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.dropdown-item{display:flex;align-items:center;width:100%;border-radius:.5rem;border:1px solid #e5e7eb;background-color:#fff;padding:.75rem;text-align:left;transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s;--tw-shadow:0 1px 2px 0 #0000000d;--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.dropdown-item:not(:last-child){margin-bottom:.5rem}.dropdown-item:hover{--tw-scale-x:1.02;--tw-scale-y:1.02;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));border-color:#60a5fa;--tw-shadow:0 10px 15px -3px #0000001a, 0 4px 6px -4px #0000001a;--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.dropdown-item-icon{margin-right:1rem;font-size:1.25rem;color:#3b82f6}.dropdown-item-title{font-size:1rem;font-weight:600;color:#1f2937}.dropdown-item-desc{font-size:.75rem;color:#6b7280}
        .fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.inset-0{top:0;right:0;bottom:0;left:0}.z-10{z-index:10}.z-20{z-index:20}.z-50{z-index:50}.mx-auto{margin-left:auto;margin-right:auto}.mx-4{margin-left:1rem;margin-right:1rem}.mb-1{margin-bottom:.25rem}.mb-2{margin-bottom:.5rem}.mb-3{margin-bottom:.75rem}.mb-4{margin-bottom:1rem}.mb-5{margin-bottom:1.25rem}.mb-6{margin-bottom:1.5rem}.mt-1{margin-top:.25rem}.mt-2{margin-top:.5rem}.mt-3{margin-top:.75rem}.mt-4{margin-top:1rem}.mr-4{margin-right:1rem}.block{display:block}.flex{display:flex}.grid{display:grid}.hidden{display:none}.h-6{height:1.5rem}.h-10{height:2.5rem}.h-16{height:4rem}.min-h-screen{min-height:100vh}.w-6{width:1.5rem}.w-1\/2{width:50%}.w-2\/3{width:66.666667%}.w-11\/12{width:91.666667%}.w-16{height:4rem}.w-full{width:100%}.max-w-md{max-width:28rem}.max-w-sm{max-width:24rem}.flex-1{flex:1 1 0%}.scale-\[1\.02\]{--tw-scale-x:1.02;--tw-scale-y:1.02}.scale-95{--tw-scale-x:.95;--tw-scale-y:.95}.transform{transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.grid-cols-1{grid-template-columns:repeat(1, minmax(0, 1fr))}.grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.grid-cols-\[1fr_auto_1fr_auto\]{grid-template-columns:1fr auto 1fr auto}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-x-3{column-gap:.75rem}.gap-2{gap:.5rem}.gap-3{gap:.75rem}.gap-4{gap:1rem}.space-y-1>*{margin-top:.25rem}.space-y-2>*{margin-top:.5rem}.space-y-3>*{margin-top:.75rem}.space-y-4>*{margin-top:1rem}.rounded{border-radius:.25rem}.rounded-lg{border-radius:.5rem}.rounded-l{border-top-left-radius:.25rem;border-bottom-left-radius:.25rem}.rounded-r{border-top-right-radius:.25rem;border-bottom-right-radius:.25rem}.rounded-xl{border-radius:.75rem}.rounded-full{border-radius:9999px}.border{border-width:1px}.border-t{border-top-width:1px}.border-b-2{border-bottom-width:2px}.border-l-4{border-left-width:4px}.border-blue-200{border-color:#bfdbfe}.border-blue-500{border-color:#3b82f6}.border-green-200{border-color:#bbf7d0}.border-indigo-200{border-color:#c7d2fe}.border-indigo-300{border-color:#a5b4fc}.border-orange-200{border-color:#fed7aa}.border-gray-100{border-color:#f3f4f6}.border-gray-200{border-color:#e5e7eb}.border-gray-300{border-color:#d1d5db}.bg-black{background-color:#000}.bg-white{background-color:#fff}.bg-gray-50{background-color:#f9fafb}.bg-gray-100{background-color:#f3f4f6}.bg-gray-200{background-color:#e5e7eb}.bg-blue-50{background-color:#eff6ff}.bg-blue-100{background-color:#dbeafe}.bg-blue-500{background-color:#3b82f6}.bg-blue-600{background-color:#2563eb}.bg-green-50{background-color:#f0fdf4}.bg-green-100{background-color:#dcfce7}.bg-green-500{background-color:#22c55e}.bg-indigo-50{background-color:#eef2ff}.bg-indigo-100{background-color:#e0e7ff}.bg-indigo-400{background-color:#818cf8}.bg-indigo-500{background-color:#6366f1}.bg-orange-50{background-color:#fff7ed}.bg-red-500{background-color:#ef4444}.bg-yellow-100{background-color:#fef9c3}.bg-yellow-400{background-color:#facc15}.bg-opacity-60{--tw-bg-opacity:0.6;background-color:rgb(0 0 0 / var(--tw-bg-opacity))}.bg-gradient-to-r{background-image:linear-gradient(to right, var(--tw-gradient-stops))}.from-blue-600{--tw-gradient-from:#2563eb;--tw-gradient-to:rgb(37 99 235 / 0);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.from-green-500{--tw-gradient-from:#22c55e;--tw-gradient-to:rgb(34 197 94 / 0);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.to-emerald-600{--tw-gradient-to:#059669}.to-indigo-700{--tw-gradient-to:#4338ca}.p-1{padding:.25rem}.p-2{padding:.5rem}.p-3{padding:.75rem}.p-4{padding:1rem}.p-6{padding:1.5rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-4{padding-left:1rem;padding-right:1rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.py-3{padding-top:.75rem;padding-bottom:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.pt-2{padding-top:.5rem}.pt-3{padding-top:.75rem}.font-mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}.text-center{text-align:center}.text-left{text-align:left}.text-right{text-align:right}.text-xs{font-size:.75rem;line-height:1rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-2xl{font-size:1.5rem;line-height:2rem}.font-bold{font-weight:700}.font-semibold{font-weight:600}.uppercase{text-transform:uppercase}.text-white{color:#fff}.text-gray-500{color:#6b7280}.text-gray-600{color:#4b5563}.text-gray-700{color:#374151}.text-blue-500{color:#3b82f6}.text-blue-600{background-color:#2563eb}.text-blue-700{color:#1d4ed8}.text-blue-800{color:#1e40af}.text-green-600{color:#16a34a}.text-green-700{color:#15803d}.text-green-800{color:#166534}.text-indigo-400{color:#818cf8}.text-indigo-700{color:#4338ca}.text-indigo-800{color:#3730a3}.text-orange-600{color:#ea580c}.text-orange-700{color:#c2410c}.text-orange-800{color:#9a3412}.text-purple-600{color:#9333ea}.text-purple-700{color:#7e22ce}.text-red-500{color:#ef4444}.opacity-0{opacity:0}.shadow-lg{--tw-shadow:0 10px 15px -3px #0000001a, 0 4px 6px -4px #0000001a;--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-xl{--tw-shadow:0 20px 25px -5px #0000001a, 0 8px 10px -6px #0000001a;--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color), 0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-2xl{--tw-shadow:0 25px 50px -12px #00000040;--tw-shadow-colored:0 25px 50px -12px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 2px 0 #0000000d;--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.duration-200{transition-duration:.2s}.duration-300{transition-duration:.3s}.first\:border-t-0:first-child{border-top-width:0px}.first\:pt-0:first-child{padding-top:0px}.first\:mt-0:first-child{margin-top:0px}.hover\:scale-\[1\.02\]:hover{--tw-scale-x:1.02;--tw-scale-y:1.02;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.hover\:bg-gray-100:hover{background-color:#f3f4f6}.hover\:bg-gray-300:hover{background-color:#d1d5db}.hover\:bg-green-600:hover{background-color:#16a34a}.hover\:bg-indigo-600:hover{background-color:#4f46e5}.hover\:bg-red-600:hover{background-color:#dc2626}.hover\:bg-yellow-500:hover{background-color:#eab308}.hover\:text-red-700:hover{color:#b91c1c}.hover\:shadow-xl:hover{--tw-shadow:0 20px 25px -5px #0000001a, 0 8px 10px -6px #0000001a;--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color), 0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}
    </style>
    <style>
        /* Dark Mode Styles */
        html.dark { color-scheme: dark; }
        html.dark body { background-color: #111827; color: #d1d5db; }
        html.dark #app, html.dark .bg-white { background-color: #1f2937; color: #d1d5db; }
        html.dark .bg-gray-50, html.dark .bg-green-50, html.dark .bg-indigo-50, html.dark .bg-blue-50, html.dark .bg-orange-50 { background-color: #374151; }
        html.dark .bg-gray-100 { background-color: #111827; }
        html.dark .text-gray-500 { color: #9ca3af; }
        html.dark .text-gray-700, html.dark .dropdown-item-title { color: #f9fafb; }
        html.dark .text-green-800, html.dark .text-blue-800, html.dark .text-orange-800, html.dark .text-indigo-800 { color: #e5e7eb; }
        html.dark .border-gray-200, html.dark .border-green-200, html.dark .border-indigo-200, html.dark .border-blue-200, html.dark .border-orange-200 { border-color: #4b5563; }
        html.dark input, html.dark select { background-color: #4b5563; color: #f9fafb; border-color: #6b7280; }
        html.dark select { background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23d1d5db' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); }
        html.dark .tab { color: #9ca3af; }
        html.dark .tab-active { background-color: #374151; }
        html.dark .dropdown-content { background-color: #374151; }
        html.dark .dropdown-item { background-color: #4b5563; border-color: #6b7280; }
        html.dark .bg-red-50 { background-color: #3f2222; }
        /* Autocomplete styles */
        .autocomplete-item { transition: background-color 0.1s ease-in-out; }
        html.dark .autocomplete-list { background-color: #4b5563; border-color: #6b7280; color: #f9fafb; }
        html.dark .autocomplete-item:hover { background-color: #6b7280; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app" class="max-w-md mx-auto bg-white min-h-screen">
        <div class="bg-blue-600 text-white p-4">
            <h1 class="text-xl font-bold text-center">Munkaidő Nyilvántartó Pro</h1>
        </div>
        <div class="flex bg-gray-100 shadow-sm">
            <button onclick="showTab('live')" id="tab-live" class="tab tab-active">🔴 Élő</button>
            <button onclick="showTab('full-day')" id="tab-full-day" class="tab">➕ Teljes nap</button>
            <button onclick="showTab('list')" id="tab-list" class="tab">📅 Lista</button>
            <div id="dropdown-container" class="relative flex-1">
                <button onclick="toggleDropdown()" id="dropdown-button" class="tab w-full">Továbbiak ▼</button>
                <div id="dropdown-menu" class="dropdown-content hidden">
                    <button onclick="showTab('summary')" class="dropdown-item"><span class="dropdown-item-icon">📊</span><div><p class="dropdown-item-title">Összesítő</p><p class="dropdown-item-desc">Napi, heti és havi adatok</p></div></button>
                    <button onclick="showTab('stats')" class="dropdown-item"><span class="dropdown-item-icon">📈</span><div><p class="dropdown-item-title">Statisztika</p><p class="dropdown-item-desc">Havi munkaidő grafikonon</p></div></button>
                    <button onclick="showTab('report')" class="dropdown-item"><span class="dropdown-item-icon">📋</span><div><p class="dropdown-item-title">Riport</p><p class="dropdown-item-desc">Nyomtatható havi elszámolás</p></div></button>
                    <button onclick="showTab('settings')" class="dropdown-item"><span class="dropdown-item-icon">⚙️</span><div><p class="dropdown-item-title">Beállítások</p><p class="dropdown-item-desc">Adatmentés és személyes adatok</p></div></button>
                </div>
            </div>
        </div>
        <div class="p-4">
            <div id="content-live" class="space-y-4">
                <h2 class="text-xl font-bold">Élő munkaidő követés</h2>
                <div id="live-start-view">
                    <div class="text-center p-4 bg-gray-100 rounded-lg"><p class="font-semibold">Nincs aktív munkanap</p></div>
                    <div class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg space-y-3">
                        <h3 class="font-semibold text-lg text-green-800">Munkanap indítása</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm mb-1">Indulás dátuma</label><input type="date" id="liveStartDate" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm mb-1">Indulás ideje</label><input type="time" id="liveStartTime" onblur="formatTimeInput(this)" class="w-full p-2 border rounded"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="relative z-10"><label class="block text-sm mb-1">Kiindulási hely</label><input type="text" id="liveStartLocation" class="w-full p-2 border rounded" placeholder="Város"></div>
                            <div><label class="block text-sm mb-1">Heti vezetés (óra)</label><input type="text" id="liveWeeklyDriveStart" onblur="formatTimeInput(this, true)" class="w-full p-2 border rounded" placeholder="28:24"></div>
                        </div>
                        <div><label class="block text-sm mb-1">Kezdő km</label><input type="number" id="liveStartKm" class="w-full p-2 border rounded" placeholder="0"></div>
                        <button onclick="startLiveShift()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 text-base"><span class="text-2xl">🚀</span> Munkanap indítás</button>
                    </div>
                </div>
                <div id="live-progress-view" class="hidden space-y-4">
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-lg"><p class="font-bold">Munkanap folyamatban</p><p id="live-start-time" class="text-sm"></p></div>
                    <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-3">
                        <h3 class="font-semibold text-indigo-800 mb-2">🛂 Új Határátlépés</h3>
                        <div id="live-crossings-list" class="text-sm space-y-1 mb-3"></div>
                        <div class="space-y-2 border-t pt-2">
                            <div class="grid grid-cols-2 gap-2">
                                <div><input type="text" id="liveCrossFrom" placeholder="Honnan" class="w-full p-2 border rounded text-sm uppercase"></div>
                                <div>
                                    <div class="flex">
                                        <input type="text" id="liveCrossTo" placeholder="Hova" class="w-full p-2 border rounded-l text-sm uppercase">
                                        <button onclick="fetchCountryCodeFor('liveCrossTo')" class="bg-blue-500 text-white p-2 rounded-r text-xs" title="Országkód lekérése GPS alapján">📍</button>
                                    </div>
                                </div>
                            </div>
                            <input type="time" id="liveCrossTime" onblur="formatTimeInput(this)" class="w-full p-2 border rounded text-sm">
                            <button onclick="addLiveCrossing()" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg text-sm">+ Határátlépés hozzáadása</button>
                        </div>
                    </div>
                    <button onclick="finalizeShift()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-700 text-white font-bold py-4 px-4 rounded-lg flex items-center justify-center gap-3 text-lg shadow-lg hover:shadow-xl transition-all duration-200 hover:scale-[1.02]"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6H8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"></path></svg>Műszak Befejezése</button>
                    <button onclick="discardShift()" class="w-full text-sm text-red-500 hover:text-red-700 mt-2">Munkanap elvetése</button>
                </div>
            </div>
            <div id="content-full-day" class="hidden space-y-4">
                <h2 class="text-xl font-bold">Teljes munkanap rögzítése</h2>
                <div><label class="block text-sm font-medium mb-1">Dátum (a munka befejezésének napja)</label><input type="date" id="date" class="w-full p-2 border rounded-lg"></div>
                <div class="bg-green-50 border border-green-200 rounded-lg p-3 space-y-3">
                    <h3 class="font-semibold text-green-800">🕐 Munkaidő és Helyszín</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="block text-xs mb-1">Kezdés ideje</label><input type="time" id="startTime" onblur="formatTimeInput(this)" class="w-full p-2 border rounded text-sm"></div>
                        <div><label class="block text-xs mb-1">Befejezés ideje</label><input type="time" id="endTime" onblur="formatTimeInput(this)" class="w-full p-2 border rounded text-sm"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="relative z-10"><label class="block text-xs mb-1">Kezdés helye</label><input type="text" id="startLocation" class="w-full p-2 border rounded text-sm" placeholder="Város"></div>
                        <div class="relative z-10"><label class="block text-xs mb-1">Befejezés helye</label><div class="flex"><input type="text" id="endLocation" class="w-full p-2 border rounded-l text-sm" placeholder="Város"><button onclick="fetchLocation()" class="bg-blue-500 text-white p-2 rounded-r text-xs" title="Helyszín lekérése GPS alapján">📍</button></div></div>
                    </div>
                    <div id="workTimeDisplay" class="text-sm text-green-700"></div><div id="nightWorkDisplay" class="text-sm text-purple-700"></div>
                </div>
                <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-3">
                    <h3 class="font-semibold text-indigo-800 mb-2">🛂 Határátlépések</h3>
                    <div id="crossingsContainer" class="space-y-2"></div>
                    <button onclick="addCrossingRow()" class="w-full mt-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg text-sm">+ Új átlépés hozzáadása</button>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <h3 class="font-semibold text-blue-800 mb-2">🚗 Heti vezetési idő (óra)</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="block text-xs mb-1">Nap elején (óó:pp)</label><input type="text" id="weeklyDriveStart" onblur="formatTimeInput(this, true)" class="w-full p-2 border rounded text-sm" placeholder="28:24"></div>
                        <div><label class="block text-xs mb-1">Nap végén (óó:pp)</label><input type="text" id="weeklyDriveEnd" onblur="formatTimeInput(this, true)" class="w-full p-2 border rounded text-sm" placeholder="32:44"></div>
                    </div>
                    <div id="driveTimeDisplay" class="mt-2 text-sm text-blue-700"></div>
                </div>
                <div class="bg-orange-50 border border-orange-200 rounded-lg p-3">
                    <h3 class="font-semibold text-orange-800 mb-2">📏 Kilométer állás</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="block text-xs mb-1">Kezdő km</label><input type="number" id="kmStart" class="w-full p-2 border rounded text-sm" placeholder="0"></div>
                        <div><label class="block text-xs mb-1">Záró km</label><input type="number" id="kmEnd" class="w-full p-2 border rounded text-sm" placeholder="0"></div>
                    </div>
                    <div id="kmDisplay" class="mt-2 text-sm text-orange-700"></div>
                </div>
                <button onclick="saveEntry()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-3 text-base shadow-lg hover:shadow-xl transition-all duration-200 hover:scale-[1.02]"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Bejegyzés Mentése</button>
            </div>
            <div id="content-list" class="hidden"><h2 class="text-lg font-semibold mb-4">Bejegyzések</h2><div id="recordsContent"></div></div>
            <div id="content-summary" class="hidden"><h2 class="text-lg font-semibold mb-4">Összesítések</h2><div id="summaryContent" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div></div>
            <div id="content-stats" class="hidden"><h2 class="text-lg font-semibold mb-4">Havi Statisztika</h2><canvas id="monthlyChart"></canvas></div>
            <div id="content-report" class="hidden">
                <h2 class="text-lg font-semibold mb-4">Havi riport</h2>
                <div class="mb-4"><label class="block text-sm font-medium mb-1">Hónap kiválasztása</label><input type="month" id="monthSelector" class="w-full p-2 border rounded-lg"></div>
                <button onclick="generateMonthlyReport()" class="w-full bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg mb-4">📋 Riport generálása</button>
                <button onclick="exportToPDF()" id="pdfExportBtn" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg mb-4 hidden">📄 PDF letöltés</button>
                <div id="monthlyReportContent"></div>
            </div>
            <div id="content-settings" class="hidden">
                <h2 class="text-lg font-semibold mb-4">Beállítások és Adatkezelés</h2>
                <div class="space-y-4">
                    <div id="sync-section" class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold mb-2">☁️ Felhő Szinkronizáció</h3>
                        <div id="logged-out-view">
                            <p class="text-sm text-gray-600 mb-3">Jelentkezz be a Google fiókoddal, hogy az adataidat a felhőbe mentsd és több eszközön is elérd.</p>
                            <button id="login-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg inline-flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.215,44,30.035,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                                Bejelentkezés
                            </button>
                        </div>
                        <div id="logged-in-view" class="hidden">
                            <p class="text-sm text-gray-600 mb-3">Bejelentkezve mint: <strong id="user-name"></strong></p>
                            <button id="logout-button" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Kijelentkezés</button>
                        </div>
                    </div>
                     <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold mb-2">Személyes adatok</h3>
                        <label class="block text-sm font-medium mb-1">Név (riportokhoz)</label>
                        <input type="text" id="userNameInput" class="w-full p-2 border rounded-lg mb-3" placeholder="Vezetéknév Keresztnév">
                        <button onclick="saveSettings()" class="w-full btn-primary">Adatok mentése</button>
                    </div>
                     <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold mb-2">Megjelenés</h3>
                        <label for="themeSelector" class="block text-sm text-gray-600 mb-1">Válassz témát</label>
                        <select id="themeSelector" onchange="setTheme(this.value)" class="w-full p-2 border rounded-lg bg-white">
                            <option value="auto">Automatikus</option>
                            <option value="light">Nappali</option>
                            <option value="dark">Éjszakai</option>
                        </select>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold mb-2">Automatikus mentés</h3>
                        <label for="autoBackupFrequency" class="block text-sm text-gray-600 mb-1">Milyen gyakran készüljön mentés?</label>
                        <select id="autoBackupFrequency" onchange="saveSettings()" class="w-full p-2 border rounded-lg bg-white">
                            <option value="never">Soha</option>
                            <option value="daily">Naponta</option>
                            <option value="weekly">Hetente</option>
                            <option value="monthly">Havonta</option>
                        </select>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold mb-2">Adatok exportálása (Backup)</h3>
                        <p class="text-sm text-gray-600 mb-3">Mentsd le az összes bejegyzésedet egy JSON fájlba.</p>
                        <button onclick="exportData()" class="w-full btn-secondary">📥 Adatok letöltése</button>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold mb-2">Adatok importálása</h3>
                        <p class="text-sm text-gray-600 mb-3">Tölts vissza egy korábban lementett adatfájlt. Figyelem: ez felülírja a jelenlegi adatokat!</p>
                        <input type="file" id="importFile" accept=".json" class="w-full text-sm">
                        <button onclick="importData()" class="w-full btn-primary mt-3">📤 Adatok visszatöltése</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="custom-alert-overlay" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 transition-opacity duration-300">
        <div id="custom-alert-box" class="bg-white rounded-xl p-6 shadow-2xl w-11/12 max-w-sm mx-auto transform transition-transform duration-300 scale-95">
            <div id="custom-alert-icon" class="w-16 h-16 mx-auto mb-5 rounded-full flex items-center justify-center"></div>
            <p id="custom-alert-message" class="text-center text-lg text-gray-700 mb-6"></p>
            <div id="custom-alert-buttons" class="flex justify-center gap-4"></div>
        </div>
    </div>
	
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyD3KtLdfZvygs8DXf9jrVrQIcGNM4tvjPw",
        authDomain: "munkaido-a58c0.firebaseapp.com",
        projectId: "munkaido-a58c0",
        storageBucket: "munkaido-a58c0.firebasestorage.app",
        messagingSenderId: "326526618039",
        appId: "1:326526618039:web:aad1c16955ffc5d9130032"
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
    </script>
	
    <script>
        // =======================================================
        // ===== ÚJ, HIBRID FIREBASE LOGIKA ======================
        // =======================================================

        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;

        // --- UI Elemek ---
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const loggedInView = document.getElementById('logged-in-view');
        const loggedOutView = document.getElementById('logged-out-view');
        const userNameEl = document.getElementById('user-name');
        
        // --- Be- és kijelentkezési események ---
        loginButton.addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(error => {
                console.error("Hiba a bejelentkezés során:", error);
                showCustomAlert(`Hiba a bejelentkezés során: ${error.message}`, 'info');
            });
        });

        logoutButton.addEventListener('click', () => {
            auth.signOut();
        });

        // --- Fő állapotkezelő ---
        auth.onAuthStateChanged(async user => {
            currentUser = user;
            updateAuthUI(user);

            if (user) {
                // FELHASZNÁLÓ BEJELENTKEZETT
                console.log("Bejelentkezve:", user.uid);
                showCustomAlert(`Sikeres bejelentkezés, ${user.displayName}! Adatok szinkronizálása a felhőből...`, 'success');
                
                const firestoreRecords = await loadRecordsFromFirestore();
                const localRecords = getRecordsFromLocal();

                if (firestoreRecords.length === 0 && localRecords.length > 0) {
                    // Első szinkronizáció: adatok feltöltése a felhőbe
                    console.log("Nincsenek felhő adatok, de vannak helyi adatok. Migráció indítása...");
                    await migrateLocalToFirestore(localRecords);
                    records = localRecords;
                } else {
                    // Adatok letöltése a felhőből, felülírva a helyit
                    records = firestoreRecords;
                }
            } else {
                // FELHASZNÁLÓ KIJELENTKEZETT
                console.log("Kijelentkezve.");
                records = getRecordsFromLocal();
            }
            // Adatok újrarajzolása a felületen
            renderApp();
        });

        function updateAuthUI(user) {
            if (user) {
                loggedInView.classList.remove('hidden');
                loggedOutView.classList.add('hidden');
                userNameEl.textContent = user.displayName || user.email;
            } else {
                loggedInView.classList.add('hidden');
                loggedOutView.classList.remove('hidden');
                userNameEl.textContent = '';
            }
        }
        
        async function migrateLocalToFirestore(localRecords) {
             if (!currentUser) return;
             const userRecordsRef = db.collection('users').doc(currentUser.uid).collection('records');
             const batch = db.batch();
             
             localRecords.forEach(record => {
                 // Firestore nem szereti a Date.now() típusú szám ID-ket, stringgé alakítjuk
                 const docRef = userRecordsRef.doc(String(record.id));
                 batch.set(docRef, record);
             });
             
             try {
                 await batch.commit();
                 showCustomAlert('A helyi adatok sikeresen a felhőbe töltve!', 'success');
             } catch (error) {
                 console.error("Hiba a helyi adatok feltöltésekor:", error);
                 showCustomAlert('Hiba történt a helyi adatok feltöltésekor.', 'info');
             }
        }

        // --- Új, absztrakt adatkezelő függvények ---
        
        function getRecordsFromLocal() {
            return JSON.parse(localStorage.getItem('workRecords') || '[]');
        }

        async function loadRecordsFromFirestore() {
            if (!currentUser) return [];
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid).collection('records').get();
                const firestoreRecords = snapshot.docs.map(doc => doc.data());
                console.log(`${firestoreRecords.length} bejegyzés betöltve a Firestore-ból.`);
                return firestoreRecords;
            } catch (error) {
                console.error("Hiba az adatok Firestore-ból való letöltésekor:", error);
                showCustomAlert("Hiba az adatok letöltésekor a felhőből.", 'info');
                return [];
            }
        }
        
        async function saveRecord(record) {
             if (currentUser) {
                // Mentés a Firestore-ba
                try {
                    const recordId = String(record.id); // Biztosítjuk, hogy az ID string
                    await db.collection('users').doc(currentUser.uid).collection('records').doc(recordId).set(record);
                    console.log("Bejegyzés mentve a Firestore-ba:", recordId);
                } catch (error) {
                    console.error("Hiba a Firestore-ba mentéskor:", error);
                    showCustomAlert("Hiba a felhőbe mentéskor.", 'info');
                }
             } else {
                // Mentés a localStorage-be
                localStorage.setItem('workRecords', JSON.stringify(records));
                console.log("Bejegyzés mentve a localStorage-be.");
             }
        }

        async function deleteRecordFromStorage(id) {
            const recordId = String(id);
            if (currentUser) {
                try {
                    await db.collection('users').doc(currentUser.uid).collection('records').doc(recordId).delete();
                    console.log("Bejegyzés törölve a Firestore-ból:", recordId);
                } catch(error) {
                     console.error("Hiba a Firestore-ból való törléskor:", error);
                    showCustomAlert("Hiba a felhőből való törléskor.", 'info');
                }
            }
        }


        // =======================================================
        // ===== EREDETI JAVASCRIPT KÓD (MÓDOSÍTÁSOKKAL) =========
        // =======================================================
        
        let records = []; // Mostantól ez a tömb a központi adatforrás, amit a login/logout logika tölt fel
        let editingId = null;
        let inProgressEntry = JSON.parse(localStorage.getItem('inProgressEntry') || 'null'); // Ezt egyelőre hagyjuk a localstorage-ben
        let monthlyChart = null;
        let uniqueLocations = [];

        document.addEventListener('DOMContentLoaded', () => {
            // A régi logika nagy része átkerül az onAuthStateChanged-be és a renderApp-be
            // Csak az induláskor szükséges, bejelentkezéstől független dolgok maradnak
            initTheme();
            loadSettings(); // A beállítások egyelőre helyben maradnak
            
            // Kezdeti betöltés a helyi tárolóból, amíg a Firebase nem válaszol
            records = getRecordsFromLocal();
            renderApp();
            
            // Eseménykezelők, amiknek mindig futniuk kell
             document.addEventListener('click', (event) => {
                const dropdownContainer = document.getElementById('dropdown-container');
                if (!dropdownContainer.contains(event.target)) {
                    closeDropdown();
                }
                if (!event.target.closest('.autocomplete-list') && !event.target.matches('input[placeholder="Város"]')) {
                    hideAutocomplete();
                }
            });
        });

        // Új központi renderelő függvény, ami frissíti a teljes UI-t
        function renderApp() {
            renderRecords();
            renderSummary();
            updateUniqueLocations();
            initAllAutocomplete();
        }

        const isoToVehicleCode = { 'at': 'A', 'de': 'D', 'hu': 'H', 'sk': 'SK', 'si': 'SLO', 'it': 'I', 'pl': 'PL', 'cz': 'CZ', 'ro': 'RO', 'ch': 'CH', 'fr': 'F', 'nl': 'NL', 'be': 'B', 'lu': 'L', 'es': 'E', 'gb': 'UK' };

        async function fetchCountryCodeFor(inputId) {
            const inputElement = document.getElementById(inputId);
            if (!inputElement) return;
            if (!navigator.geolocation) { showCustomAlert('A böngésződ nem támogatja a helymeghatározást.', 'info'); return; }
            const originalPlaceholder = inputElement.placeholder;
            inputElement.value = "Keresés...";
            try {
                const position = await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 }));
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.coords.latitude}&lon=${position.coords.longitude}&accept-language=en`);
                if (!response.ok) throw new Error('API hiba');
                const data = await response.json();
                const countryCode = data.address.country_code;
                if (countryCode && isoToVehicleCode[countryCode]) {
                    inputElement.value = isoToVehicleCode[countryCode];
                } else {
                    inputElement.value = (countryCode || 'N/A').toUpperCase();
                }
            } catch (error) {
                inputElement.value = "";
                showCustomAlert(`Helyszín lekérése sikertelen. Ellenőrizd az internetkapcsolatot és a böngésző helymeghatározási engedélyét.`, 'info');
            } finally {
                if (inputElement.value === "Keresés...") { inputElement.value = ""; }
                inputElement.placeholder = originalPlaceholder;
            }
        }
        
        function runAutoBackup() {
            console.log("AutoBackup funkció felfüggesztve a Firestore integráció miatt.");
        }

        function toggleDropdown() { document.getElementById('dropdown-menu').classList.toggle('hidden'); }
        function closeDropdown() { document.getElementById('dropdown-menu').classList.add('hidden'); }
        let alertCallback = null;
        function showCustomAlert(message, type, callback) {
            const overlay = document.getElementById('custom-alert-overlay');
            const box = document.getElementById('custom-alert-box');
            const iconContainer = document.getElementById('custom-alert-icon');
            const messageEl = document.getElementById('custom-alert-message');
            const buttonsContainer = document.getElementById('custom-alert-buttons');
            messageEl.textContent = message;
            alertCallback = callback || null;
            iconContainer.className = 'w-16 h-16 mx-auto mb-5 rounded-full flex items-center justify-center';
            buttonsContainer.innerHTML = '';
            const warningIcon = `<svg class="w-10 h-10 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`;
            if (type === 'warning') {
                iconContainer.classList.add('bg-yellow-100');
                iconContainer.innerHTML = warningIcon;
                buttonsContainer.innerHTML = `<button onclick="hideCustomAlert(false)" class="py-2 px-6 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">Mégse</button><button onclick="hideCustomAlert(true)" class="py-2 px-6 bg-yellow-400 text-white rounded-lg font-semibold hover:bg-yellow-500">Mentés</button>`;
            } else if (type === 'info') {
                iconContainer.classList.add('bg-yellow-100');
                iconContainer.innerHTML = warningIcon;
                buttonsContainer.innerHTML = `<button onclick="hideCustomAlert(true)" class="py-2 w-2/3 bg-yellow-400 text-white rounded-lg font-semibold hover:bg-yellow-500">Oké</button>`;
            } else if (type === 'success') {
                iconContainer.classList.add('bg-green-100');
                iconContainer.innerHTML = `<svg class="w-10 h-10 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
                buttonsContainer.innerHTML = `<button onclick="hideCustomAlert(true)" class="py-2 w-2/3 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600">Rendben</button>`;
            }
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            setTimeout(() => {
                overlay.classList.remove('opacity-0');
                box.classList.remove('scale-95');
            }, 10);
        }
        function hideCustomAlert(isConfirmed) {
            const overlay = document.getElementById('custom-alert-overlay');
            const box = document.getElementById('custom-alert-box');
            overlay.classList.add('opacity-0');
            box.classList.add('scale-95');
            setTimeout(() => {
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
                if (isConfirmed && alertCallback) {
                    alertCallback();
                }
                alertCallback = null;
            }, 300);
        }
        function saveEntry() {
            // ... (meglévő beolvasó logika)
            const kmStart = parseFloat(document.getElementById('kmStart').value) || 0;
            const kmEnd = parseFloat(document.getElementById('kmEnd').value) || 0;
            const weeklyDriveStartStr = document.getElementById('weeklyDriveStart').value.trim();
            const weeklyDriveEndStr = document.getElementById('weeklyDriveEnd').value.trim();
            if (kmEnd > 0 && kmEnd < kmStart) { showCustomAlert('Hiba: A záró kilométer nem lehet kevesebb, mint a kezdő!', 'info'); return; }
            if (parseTimeToMinutes(weeklyDriveEndStr) > 0 && parseTimeToMinutes(weeklyDriveEndStr) < parseTimeToMinutes(weeklyDriveStartStr)) { showCustomAlert('Hiba: A heti vezetési idő a nap végén nem lehet kevesebb, mint a nap elején!', 'info'); return; }
            
            const recordData = { 
                date: document.getElementById('date').value, 
                startTime: document.getElementById('startTime').value, 
                endTime: document.getElementById('endTime').value, 
                startLocation: document.getElementById('startLocation').value.trim(), 
                endLocation: document.getElementById('endLocation').value.trim(), 
                weeklyDriveStartStr, weeklyDriveEndStr, kmStart, kmEnd, 
                crossings: [] 
            };
            
            if (!recordData.date || !recordData.startTime || !recordData.endTime) { showCustomAlert('A dátum és a munkaidő megadása kötelező!', 'info'); return; }
            
            const record = {
                ...recordData,
                id: editingId || Date.now(),
                workMinutes: calculateWorkMinutes(recordData.startTime, recordData.endTime),
                nightWorkMinutes: calculateNightWorkMinutes(recordData.startTime, recordData.endTime),
                driveMinutes: (parseTimeToMinutes(recordData.weeklyDriveEndStr) > parseTimeToMinutes(recordData.weeklyDriveStartStr)) ? (parseTimeToMinutes(recordData.weeklyDriveEndStr) - parseTimeToMinutes(recordData.weeklyDriveStartStr)) : 0,
                kmDriven: Math.max(0, recordData.kmEnd - recordData.kmStart)
            };

            const proceedWithSave = () => {
                document.querySelectorAll('#crossingsContainer .border-t').forEach(row => {
                    const from = row.querySelector(`input[id^="crossFrom-"]`).value.trim().toUpperCase();
                    const to = row.querySelector(`input[id^="crossTo-"]`).value.trim().toUpperCase();
                    const time = row.querySelector(`input[id^="crossTime-"]`).value;
                    if (from && to && time) record.crossings.push({ from, to, time });
                });
                
                if (editingId) {
                    records = records.map(r => r.id === editingId ? record : r);
                } else {
                    records.push(record);
                }
                
                saveRecord(record).then(() => {
                    showCustomAlert('Bejegyzés sikeresen mentve!', 'success', () => {
                        if (inProgressEntry) {
                            localStorage.removeItem('inProgressEntry');
                            inProgressEntry = null;
                        }
                        showTab('list');
                        renderApp();
                    });
                });
            };

            if (record.driveMinutes === 0 || record.kmDriven === 0) {
                showCustomAlert('A vezetési idő vagy a megtett kilométer 0. Biztosan így szeretnéd menteni?', 'warning', proceedWithSave);
            } else {
                proceedWithSave();
            }
        }
        function showTab(tabName) {
            const allTabs = document.querySelectorAll('.tab');
            const mainTabs = ['live', 'full-day', 'list'];
            const dropdownButton = document.getElementById('dropdown-button');
            const dropdownMenu = document.getElementById('dropdown-menu');
            allTabs.forEach(t => t.classList.remove('tab-active'));
            dropdownButton.classList.remove('tab-active');
            if (mainTabs.includes(tabName)) {
                document.getElementById(`tab-${tabName}`).classList.add('tab-active');
                dropdownButton.innerHTML = 'Továbbiak ▼';
            } else {
                dropdownButton.classList.add('tab-active');
                const buttonInDropdown = dropdownMenu.querySelector(`button[onclick="showTab('${tabName}')"]`);
                const selectedTitle = buttonInDropdown.querySelector(`.dropdown-item-title`).innerText;
                dropdownButton.innerHTML = `${selectedTitle} ▼`;
            }
            document.querySelectorAll('[id^="content-"]').forEach(c => c.classList.add('hidden'));
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            closeDropdown();
            if (tabName === 'live') renderLiveTabView();
            if (tabName === 'full-day') showFullFormView();
            if (tabName === 'list') renderRecords();
            if (tabName === 'summary') renderSummary();
            if (tabName === 'stats') renderStats();
            if (tabName === 'report') initMonthlyReport();
        }
        function renderLiveTabView() {
            // Az "Élő" fül logikája egyelőre a localStorage-ben marad, mert ez eszköz-specifikus.
            inProgressEntry = JSON.parse(localStorage.getItem('inProgressEntry') || 'null');
            const startView = document.getElementById('live-start-view');
            const progressView = document.getElementById('live-progress-view');
            if (inProgressEntry) {
                startView.classList.add('hidden');
                progressView.classList.remove('hidden');
                document.getElementById('live-start-time').textContent = `Elkezdve: ${inProgressEntry.date} ${inProgressEntry.startTime}`;
                const liveCrossList = document.getElementById('live-crossings-list');
                const liveCrossFrom = document.getElementById('liveCrossFrom');
                if (inProgressEntry.crossings && inProgressEntry.crossings.length > 0) {
                    const crossingsHTML = inProgressEntry.crossings.map(c => 
                        `<div class="grid grid-cols-[1fr_auto_1fr_auto] gap-x-3 items-center border-t border-indigo-200 pt-2 mt-2 first:border-t-0 first:pt-0 first:mt-0">
                            <span class="text-right font-mono text-indigo-800 font-bold text-base">${c.from}</span>
                            <span class="text-indigo-400">→</span>
                            <span class="font-mono text-indigo-800 font-bold text-base">${c.to}</span>
                            <span class="text-sm font-semibold text-white bg-indigo-400 px-2 py-1 rounded-full">${c.time}</span>
                        </div>`
                    ).join('');
                    liveCrossList.innerHTML = `<div class="bg-indigo-100 border border-indigo-300 rounded-lg p-3"><h4 class="font-bold text-indigo-800 text-sm mb-2">Rögzített átlépések:</h4>${crossingsHTML}</div>`;
                    liveCrossFrom.value = inProgressEntry.crossings[inProgressEntry.crossings.length - 1].to;
                } else {
                    liveCrossList.innerHTML = '';
                    let lastKnownCountry = '';
                    const sortedRecords = getSortedRecords();
                    if (sortedRecords.length > 0) {
                        for (const record of sortedRecords) {
                            if (record.crossings && record.crossings.length > 0) {
                                lastKnownCountry = record.crossings[record.crossings.length - 1].to;
                                if (lastKnownCountry) break;
                            }
                        }
                    }
                    liveCrossFrom.value = lastKnownCountry;
                }
                document.getElementById('liveCrossTo').value = '';
                document.getElementById('liveCrossTime').value = new Date().toTimeString().slice(0, 5);
            } else {
                progressView.classList.add('hidden');
                startView.classList.remove('hidden');
                loadLastValues(true);
            }
        }
        function startLiveShift() {
            inProgressEntry = { date: document.getElementById('liveStartDate').value, startTime: document.getElementById('liveStartTime').value, startLocation: document.getElementById('liveStartLocation').value, weeklyDriveStartStr: document.getElementById('liveWeeklyDriveStart').value, kmStart: parseFloat(document.getElementById('liveStartKm').value) || 0, crossings: [] };
            if (!inProgressEntry.date || !inProgressEntry.startTime) { showCustomAlert("A dátum és az indulási idő megadása kötelező!", "info"); return; }
            localStorage.setItem('inProgressEntry', JSON.stringify(inProgressEntry));
            renderLiveTabView();
        }
        function addLiveCrossing() {
            const from = document.getElementById('liveCrossFrom').value.trim().toUpperCase();
            const to = document.getElementById('liveCrossTo').value.trim().toUpperCase();
            const time = document.getElementById('liveCrossTime').value;
            if (!from || !to || !time) { showCustomAlert("Kérlek tölts ki minden mezőt!", "info"); return; }
            inProgressEntry.crossings.push({ from, to, time });
            localStorage.setItem('inProgressEntry', JSON.stringify(inProgressEntry));
            renderLiveTabView();
        }
        function finalizeShift() {
            showTab('full-day');
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            document.getElementById('startTime').value = inProgressEntry.startTime;
            document.getElementById('startLocation').value = inProgressEntry.startLocation || '';
            document.getElementById('kmStart').value = inProgressEntry.kmStart || '';
            document.getElementById('weeklyDriveStart').value = inProgressEntry.weeklyDriveStartStr || '';
            (inProgressEntry.crossings || []).forEach(c => addCrossingRow(c.from, c.to, c.time));
            document.getElementById('endTime').focus();
        }
        function discardShift() {
            if (confirm("Biztosan elveted a folyamatban lévő munkanapot? Minden adat elvész.")) {
                localStorage.removeItem('inProgressEntry');
                inProgressEntry = null;
                renderLiveTabView();
            }
        }
        function getSortedRecords() { return [...records].sort((a, b) => { try { const dateA = new Date(`${a.date||"1970-01-01"}T${a.startTime||"00:00"}`); const dateB = new Date(`${b.date||"1970-01-01"}T${b.startTime||"00:00"}`); if (isNaN(dateA.getTime())) return 1; if (isNaN(dateB.getTime())) return -1; return dateB - dateA } catch (e) { return 0 } }); }
        function getLatestRecord() { if (!records || records.length === 0) return null; const sorted = getSortedRecords(); return sorted.length > 0 ? sorted[0] : null; }
        function showFullFormView() { resetEntryForm(); loadLastValues(); }
        function loadLastValues(forLiveForm = false) {
            const lastRecord = getLatestRecord();
            const now = new Date();
            if (forLiveForm) {
                document.getElementById('liveStartDate').value = now.toISOString().split('T')[0];
                document.getElementById('liveStartTime').value = now.toTimeString().slice(0, 5);
                if (lastRecord) {
                    document.getElementById('liveStartLocation').value = lastRecord.endLocation || '';
                    document.getElementById('liveWeeklyDriveStart').value = lastRecord.weeklyDriveEndStr || '';
                    document.getElementById('liveStartKm').value = lastRecord.kmEnd || '';
                }
            } else {
                if (lastRecord) {
                    document.getElementById('weeklyDriveStart').value = lastRecord.weeklyDriveEndStr || '';
                    document.getElementById('kmStart').value = lastRecord.kmEnd || '';
                    document.getElementById('startLocation').value = lastRecord.endLocation || '';
                }
            }
        }
        function resetEntryForm() { document.getElementById('date').value = new Date().toISOString().split('T')[0];
            ['startTime', 'endTime', 'startLocation', 'endLocation', 'weeklyDriveStart', 'weeklyDriveEnd', 'kmStart', 'kmEnd'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('crossingsContainer').innerHTML = '';
            editingId = null; }
        function updateDisplays() { const start = document.getElementById('startTime').value; const end = document.getElementById('endTime').value; if (start && end) { const workMinutes = calculateWorkMinutes(start, end); const nightMinutes = calculateNightWorkMinutes(start, end);
                document.getElementById('workTimeDisplay').textContent = `Munkaidő: ${formatDuration(workMinutes)}`;
                document.getElementById('nightWorkDisplay').textContent = `Éjszakai (20:00-05:00): ${formatDuration(nightMinutes)}`; } else { document.getElementById('workTimeDisplay').textContent = '';
                document.getElementById('nightWorkDisplay').textContent = ''; } const driveStart = document.getElementById('weeklyDriveStart').value.trim(); const driveEnd = document.getElementById('weeklyDriveEnd').value.trim(); if (driveStart && driveEnd) { const diff = parseTimeToMinutes(driveEnd) - parseTimeToMinutes(driveStart);
                document.getElementById('driveTimeDisplay').textContent = diff >= 0 ? `Mai vezetési idő: ${formatDuration(diff)}` : ''; } else { document.getElementById('driveTimeDisplay').textContent = ''; } const kmStart = parseFloat(document.getElementById('kmStart').value) || 0; const kmEnd = parseFloat(document.getElementById('kmEnd').value) || 0; if (kmEnd > kmStart) { document.getElementById('kmDisplay').textContent = `Megtett km: ${kmEnd - kmStart} km`; } else { document.getElementById('kmDisplay').textContent = ''; } }
        ['startTime', 'endTime', 'weeklyDriveStart', 'weeklyDriveEnd', 'kmStart', 'kmEnd'].forEach(id => { if (document.getElementById(id)) document.getElementById(id).addEventListener('input', updateDisplays); });
        function addCrossingRow(from = '', to = '', time = '') { 
            const container = document.getElementById('crossingsContainer'); 
            let newFrom = from; 
            if (!from) { 
                const allToInputs = container.querySelectorAll('input[id^="crossTo-"]'); 
                const lastToInput = allToInputs[allToInputs.length - 1];
                newFrom = lastToInput ? lastToInput.value.toUpperCase() : ''; 
            } 
            const index = Date.now(); 
            const newRow = document.createElement('div');
            newRow.className = 'border-t pt-3 mt-2 space-y-2';
            newRow.innerHTML = `
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <input type="text" id="crossFrom-${index}" value="${newFrom}" placeholder="Honnan" class="w-full p-2 border rounded text-sm uppercase">
                    </div>
                    <div>
                        <div class="flex">
                            <input type="text" id="crossTo-${index}" value="${to}" placeholder="Hova" class="w-full p-2 border rounded-l text-sm uppercase">
                            <button type="button" onclick="fetchCountryCodeFor('crossTo-${index}')" class="bg-blue-500 text-white p-2 rounded-r text-xs" title="Országkód lekérése GPS alapján">📍</button>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <input type="time" id="crossTime-${index}" value="${time}" onblur="formatTimeInput(this)" class="w-full p-2 border rounded text-sm">
                    <button onclick="this.closest('.border-t').remove()" class="bg-red-500 text-white p-2 rounded text-sm hover:bg-red-600">Törlés</button>
                </div>`;
            container.appendChild(newRow); 
        }
        async function fetchLocation() { if (!navigator.geolocation) { showCustomAlert('A böngésződ nem támogatja a helymeghatározást.', 'info'); return; } const endLocationInput = document.getElementById('endLocation');
            endLocationInput.value = "Keresés..."; try { const position = await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 })); const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.coords.latitude}&lon=${position.coords.longitude}&accept-language=de`); if (!response.ok) throw new Error('API hiba'); const data = await response.json();
                endLocationInput.value = data.address.city || data.address.town || data.address.village || 'Ismeretlen hely'; } catch (error) { endLocationInput.value = "";
                showCustomAlert(`Helyszín lekérése sikertelen. Ellenőrizd a böngésző beállításait.`, 'info'); } }
        function editRecord(id) { const record = records.find(r => r.id === id); if (!record) return;
            editingId = id;
            showTab('full-day');
            document.getElementById('date').value = record.date;
            document.getElementById('startTime').value = record.startTime;
            document.getElementById('endTime').value = record.endTime;
            document.getElementById('startLocation').value = record.startLocation || '';
            document.getElementById('endLocation').value = record.endLocation || '';
            document.getElementById('weeklyDriveStart').value = record.weeklyDriveStartStr || '';
            document.getElementById('weeklyDriveEnd').value = record.weeklyDriveEndStr || '';
            document.getElementById('kmStart').value = record.kmStart || '';
            document.getElementById('kmEnd').value = record.kmEnd || '';
            document.getElementById('crossingsContainer').innerHTML = '';
            (record.crossings || []).forEach(c => addCrossingRow(c.from, c.to, c.time));
            updateDisplays(); }
        function deleteRecord(id) { 
            if (confirm('Biztosan törölni szeretnéd?')) { 
                records = records.filter(r => r.id !== id);
                deleteRecordFromStorage(id); // Törlés a felhőből
                if(!currentUser) { // Ha offline, a localstorage-t is frissítjük
                    localStorage.setItem('workRecords', JSON.stringify(records));
                }
                renderApp();
            } 
        }
        function renderRecords() { const container = document.getElementById('recordsContent'); if (!container) return;
            container.innerHTML = records.length === 0 ? '<p class="text-center text-gray-500 py-8">Még nincsenek bejegyzések</p>' : getSortedRecords().map(r => { const d = new Date(r.date); const day = d.getUTCDay(); const weekendClass = (day === 6 || day === 0) ? 'bg-red-50' : ''; const isOvernight = new Date(`1970-01-01T${r.endTime}`) < new Date(`1970-01-01T${r.startTime}`); const endDate = new Date(r.date + 'T00:00:00'); let startDate = new Date(r.date + 'T00:00:00'); if (isOvernight) { startDate.setDate(startDate.getDate() - 1); } const formatShortDate = (dt) => dt.toLocaleDateString('hu-HU', { month: '2-digit', day: '2-digit' }); return `<div class="bg-gray-50 rounded-lg p-3 mb-3 text-sm ${weekendClass}"><div class="flex items-center justify-between mb-2"><div class="font-semibold">${isOvernight?`${startDate.toLocaleDateString("hu-HU")} - ${endDate.toLocaleDateString("hu-HU")}`:endDate.toLocaleDateString("hu-HU")}</div><div><button onclick="editRecord(${r.id})" class="text-blue-500 p-1">✏️</button><button onclick="deleteRecord(${r.id})" class="text-red-500 p-1">🗑️</button></div></div><div class="space-y-1"><div class="flex justify-between"><span>Indulás:</span><span>${isOvernight?formatShortDate(startDate):""} ${r.startTime} (${r.startLocation||"N/A"})</span></div><div class="flex justify-between"><span>Érkezés:</span><span>${formatShortDate(endDate)} ${r.endTime} (${r.endLocation||"N/A"})</span></div><div class="flex justify-between border-t pt-1 mt-1"><span>Munkaidő:</span><span class="font-bold">${formatDuration(r.workMinutes)}</span></div><div class="flex justify-between"><span>Éjszakai:</span><span class="text-purple-600">${formatDuration(r.nightWorkMinutes||0)}</span></div><div class="flex justify-between"><span>Vezetés:</span><span class="text-blue-700">${formatDuration(r.driveMinutes)}</span></div><div class="flex justify-between"><span>Távolság:</span><span>${r.kmDriven} km</span></div>${(r.crossings&&r.crossings.length>0)?`<div class="border-t pt-2 mt-2"><p class="font-semibold text-xs text-indigo-700">Határátlépések:</p><div class="text-xs text-gray-600 pl-2">${r.crossings.map(c=>`<span>${c.from} - ${c.to} (${c.time})</span>`).join("<br>")}</div></div>`:""}</div></div>`; }).join(''); }
        function renderSummary() { const container = document.getElementById('summaryContent'); if (!container) return; const today = new Date(); const summaries = [{ title: 'Ma', data: calculateSummaryForDate(new Date()) }, { title: 'Tegnap', data: calculateSummaryForDate(new Date(new Date().setDate(today.getDate() - 1))) }, { title: 'Aktuális hét', data: calculateSummaryForDateRange(getWeekRange(new Date())) }, { title: 'Múlt hét', data: calculateSummaryForDateRange(getWeekRange(new Date(), -1)) }, { title: 'Aktuális hónap', data: calculateSummaryForMonth(new Date()) }, { title: 'Előző hónap', data: calculateSummaryForMonth(new Date(new Date().setMonth(today.getMonth() - 1))) }];
            container.innerHTML = summaries.map(s => `<div class="bg-blue-50 rounded-lg p-3"><h3 class="font-semibold mb-2">${s.title} ${s.data.days>0?`(${s.data.days} nap)`:""}</h3>${s.data.days>0?`<div class="grid grid-cols-2 gap-2 text-center text-sm"><div><div class="font-bold text-green-600">${formatDuration(s.data.workMinutes)}</div><div class="text-xs">Munka</div></div><div><div class="font-bold text-purple-600">${formatDuration(s.data.nightWorkMinutes)}</div><div class="text-xs">Éjszakai</div></div><div><div class="font-bold text-blue-700">${formatDuration(s.data.driveMinutes)}</div><div class="text-xs">Vezetés</div></div><div><div class="font-bold text-orange-600">${s.data.kmDriven} km</div><div class="text-xs">Táv</div></div></div>`:'<p class="text-center text-xs text-gray-500">Nincs adat</p>'}</div>`).join(''); };
        function renderStats() { const ctx = document.getElementById('monthlyChart').getContext('2d'); const labels = []; const workData = []; const nightData = []; const driveData = []; for (let i = 5; i >= 0; i--) { const d = new Date();
                d.setMonth(d.getMonth() - i);
                labels.push(d.toLocaleString('hu-HU', { month: 'long' })); const monthData = calculateSummaryForMonth(d);
                workData.push(monthData.workMinutes / 60);
                nightData.push(monthData.nightWorkMinutes / 60);
                driveData.push(monthData.driveMinutes / 60); }
            if (monthlyChart) { monthlyChart.destroy(); }
            monthlyChart = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Munkaidő (óra)', data: workData, backgroundColor: 'rgba(54, 162, 235, 0.6)' }, { label: 'Éjszakai (óra)', data: nightData, backgroundColor: 'rgba(153, 102, 255, 0.6)' }, { label: 'Vezetés (óra)', data: driveData, backgroundColor: 'rgba(255, 159, 64, 0.6)' }] }, options: { scales: { y: { beginAtZero: true, ticks: { callback: function(value) { return value + ' óra' } } } } } }); };
        const toISODate = d => d.toISOString().split('T')[0];
        function calculateSummary(filterFn) { return records.filter(filterFn).reduce((acc, r) => ({ workMinutes: acc.workMinutes + (r.workMinutes || 0), nightWorkMinutes: acc.nightWorkMinutes + (r.nightWorkMinutes || 0), driveMinutes: acc.driveMinutes + (r.driveMinutes || 0), kmDriven: acc.kmDriven + (r.kmDriven || 0), days: acc.days + 1 }), { workMinutes: 0, nightWorkMinutes: 0, driveMinutes: 0, kmDriven: 0, days: 0 }); }
        function calculateSummaryForDate(date) { const dateStr = toISODate(date); return calculateSummary(r => r.date === dateStr); }
        function calculateSummaryForDateRange({ start, end }) { const startStr = toISODate(start); const endStr = toISODate(end); return calculateSummary(r => r.date >= startStr && r.date <= endStr); }
        function calculateSummaryForMonth(date) { const monthStr = date.toISOString().slice(0, 7); return calculateSummary(r => r.date.startsWith(monthStr)); }
        function getWeekRange(date, offset = 0) { const d = new Date(date);
            d.setDate(d.getDate() + (offset * 7)); const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1); const start = new Date(d.setDate(diff)); const end = new Date(start);
            end.setDate(start.getDate() + 6); return { start, end }; }
        function calculateWorkMinutes(start, end) { if (!start || !end) return 0; const s = new Date(`2000-01-01T${start}`); let e = new Date(`2000-01-01T${end}`); if (e < s) e.setDate(e.getDate() + 1); return Math.floor((e - s) / 60000); }
        function calculateNightWorkMinutes(startTime, endTime) { if (!startTime || !endTime) return 0; const start = new Date(`1970-01-01T${startTime}`); let end = new Date(`1970-01-01T${endTime}`); if (end <= start) end.setDate(end.getDate() + 1); let nightMinutes = 0; let current = new Date(start); while (current < end) { const hour = current.getHours(); if (hour >= 20 || hour < 5) { nightMinutes++; }
                current.setMinutes(current.getMinutes() + 1); } return nightMinutes; }
        function parseTimeToMinutes(timeStr) { if (!timeStr || !timeStr.includes(':')) return 0; const p = timeStr.split(':'); if (p.length !== 2) return 0; return parseInt(p[0], 10) * 60 + parseInt(p[1], 10); }
        function formatDuration(minutes) { const h = Math.floor(minutes / 60); const m = minutes % 60; return `${h}ó ${m}p`; }
        function formatTimeInput(inputElement, allowHoursOver24 = false) { let value = inputElement.value.replace(/[^0-9]/g, ''); if (value.length < 3) return; if (value.length === 3 && !allowHoursOver24) value = '0' + value; const hours = parseInt(value.substring(0, value.length - 2), 10); const minutes = parseInt(value.substring(value.length - 2), 10); if (minutes >= 0 && minutes <= 59 && hours >= 0 && (allowHoursOver24 || hours <= 23)) { inputElement.value = `${String(hours).padStart(2,"0")}:${String(minutes).padStart(2,"0")}`; } else { inputElement.value = ''; }
            updateDisplays(); }
        const germanMonths = ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
        const germanDays = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
        let currentMonthlyData = null;
        function formatTimeGerman(b) { const c = Math.floor(b / 60),
                d = b % 60; return `${c.toString().padStart(2,"0")}:${d.toString().padStart(2,"0")}` }
        function formatDateGerman(dateObj) { if (!(dateObj instanceof Date) || isNaN(dateObj)) return 'Hibás Dátum'; const d = dateObj.getUTCDate().toString().padStart(2, "0"),
                e = (dateObj.getUTCMonth() + 1).toString().padStart(2, "0"),
                f = dateObj.getUTCFullYear(),
                g = germanDays[dateObj.getUTCDay()]; return `${g}, ${d}.${e}.${f}` }
        function initMonthlyReport() { document.getElementById('monthSelector').value = new Date().toISOString().slice(0, 7);
            document.getElementById('monthlyReportContent').innerHTML = '';
            document.getElementById('pdfExportBtn').classList.add('hidden'); }
        function generateMonthlyReport() { const selectedMonth = document.getElementById("monthSelector").value; const monthRecords = records.filter(record => record.date.startsWith(selectedMonth)); if (monthRecords.length === 0) { document.getElementById("monthlyReportContent").innerHTML = '<div class="text-center text-gray-500 py-8">Nincs adat</div>'; return; }
            monthRecords.sort((a, b) => new Date(a.date) - new Date(b.date)); const [year, month] = selectedMonth.split('-'); const monthName = germanMonths[parseInt(month) - 1];
            currentMonthlyData = { month: `${monthName} ${year}`, records: monthRecords }; const reportHTML = `<div class="bg-white"><div class="text-center mb-6"><h1 class="text-2xl font-bold">ARBEITSZEIT-NACHWEIS</h1><h2 class="text-xl text-gray-600">${monthName} ${year}</h2></div><div class="overflow-x-auto"><table class="w-full text-xs border-collapse border border-gray-300"><thead><tr class="bg-gray-100"><th class="border p-2 text-left">Datum</th><th class="border p-2">Beginn/Ort</th><th class="border p-2">Ende/Ort</th><th class="border p-2">Arbeitsz.</th><th class="border p-2">Nachtz.</th><th class="border p-2">Fahrtz.</th><th class="border p-2">km</th></tr></thead><tbody>${monthRecords.map(record=>{const isOvernight=new Date(`1970-01-01T${record.endTime}`)<new Date(`1970-01-01T${record.startTime}`);const endDate=new Date(record.date+"T00:00:00Z");let startDate=new Date(endDate);if(isOvernight)startDate.setUTCDate(startDate.getUTCDate()-1);return`<tr><td class="border p-2">${formatDateGerman(startDate)}</td><td class="border p-2 text-center">${record.startTime}<br><span class="text-gray-500">${record.startLocation||"-"}</span></td><td class="border p-2 text-center">${record.endTime}<br><span class="text-gray-500">${record.endLocation||"-"}</span></td><td class="border p-2 text-center font-semibold">${formatTimeGerman(record.workMinutes)}</td><td class="border p-2 text-center text-purple-600">${formatTimeGerman(record.nightWorkMinutes||0)}</td><td class="border p-2 text-center text-blue-600">${formatTimeGerman(record.driveMinutes)}</td><td class="border p-2 text-center">${record.kmDriven}</td></tr>${(r.crossings&&r.crossings.length>0)?`<tr class="bg-indigo-50"><td class="border p-1 text-right text-indigo-800 font-semibold" colspan="3">Grenzübergänge:</td><td class="border p-1 text-indigo-700" colspan="4">${record.crossings.map(c=>`${c.from} - ${c.to} (${c.time})`).join(", ")}</td></tr>`:""}`}).join('')}</tbody></table></div></div>`;
            document.getElementById('monthlyReportContent').innerHTML = reportHTML;
            document.getElementById('pdfExportBtn').classList.remove('hidden'); }
        function exportToPDF() { try { if (!currentMonthlyData) { alert("Először generálj riportot!"); return; } const { jsPDF } = window.jspdf; const doc = new jsPDF(); const userName = document.getElementById('userNameInput').value || '';
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('ARBEITSZEIT-NACHWEIS', 105, 15, { align: 'center' });
                doc.setFontSize(14);
                doc.setFont(undefined, 'normal');
                doc.text(currentMonthlyData.month, 105, 23, { align: 'center' }); if (userName) { doc.setFontSize(12);
                    doc.text(userName, 105, 31, { align: 'center' }); } let yPos = 40; const pageBottom = 280; const leftMargin = 15; const tableWidth = 180; const headers = ['Datum', 'Beginn/Ort', 'Ende/Ort', 'Arbeit', 'Nacht', 'Fahrt', 'km']; const colWidths = [30, 37, 37, 18, 18, 18, 17]; const drawHeader = () => { doc.setFontSize(9);
                    doc.setFont(undefined, 'bold'); let xPos = leftMargin;
                    headers.forEach((h, i) => { doc.rect(xPos, yPos, colWidths[i], 6);
                        doc.text(h, xPos + colWidths[i] / 2, yPos + 4, { align: 'center' });
                        xPos += colWidths[i]; });
                    yPos += 6;
                    doc.setFont(undefined, 'normal'); };
                drawHeader();
                currentMonthlyData.records.forEach(record => { const isOvernight = new Date(`1970-01-01T${record.endTime}`) < new Date(`1970-01-01T${record.startTime}`); const endDate = new Date(record.date + 'T00:00:00Z'); let startDate = new Date(endDate); if (isOvernight) startDate.setUTCDate(startDate.getUTCDate() - 1); const hasCrossings = record.crossings && record.crossings.length > 0; const rowData = [`${formatDateGerman(startDate).slice(4)}`, `${record.startTime}\n${record.startLocation||"-"}`, `${isOvernight?formatDateGerman(endDate).slice(4)+" ":""}${record.endTime}\n${record.endLocation||"-"}`, formatTimeGerman(record.workMinutes), formatTimeGerman(record.nightWorkMinutes || 0), formatTimeGerman(record.driveMinutes), String(record.kmDriven || 0)]; let maxLines = 1;
                    rowData.forEach((data, i) => maxLines = Math.max(maxLines, doc.splitTextToSize(data, colWidths[i] - 2).length)); const mainRowHeight = maxLines * 4.5 + 3; let crossingBlockHeight = 0; let crossingLines = []; if (hasCrossings) { const crossingsText = `Grenzübergänge: ${record.crossings.map(c=>`${c.from} - ${c.to} (${c.time})`).join(", ")}`;
                        crossingLines = doc.splitTextToSize(crossingsText, tableWidth - 4);
                        crossingBlockHeight = crossingLines.length * 3.5 + 3; } const totalBlockHeight = mainRowHeight + crossingBlockHeight; if (yPos + totalBlockHeight > pageBottom) { doc.addPage();
                        yPos = 20;
                        drawHeader(); } let xPos = leftMargin;
                    rowData.forEach((data, i) => { doc.rect(xPos, yPos, colWidths[i], mainRowHeight);
                        doc.text(data, xPos + colWidths[i] / 2, yPos + mainRowHeight / 2, { align: 'center', baseline: 'middle' });
                        xPos += colWidths[i]; }); if (hasCrossings) { yPos += mainRowHeight;
                        doc.setFillColor(245, 245, 245);
                        doc.rect(leftMargin, yPos, tableWidth, crossingBlockHeight, 'F');
                        doc.setFontSize(7);
                        doc.setFont(undefined, 'italic');
                        doc.text(crossingLines, leftMargin + 2, yPos + crossingBlockHeight / 2, { baseline: 'middle' });
                        doc.setFontSize(9);
                        doc.setFont(undefined, 'normal');
                        yPos += crossingBlockHeight; } else { yPos += mainRowHeight; } });
                doc.save(`Arbeitszeit-${userName.replace(/ /g,"_")}-${currentMonthlyData.month}.pdf`); } catch (e) { console.error("PDF generálási hiba:", e);
                alert("Hiba történt a PDF generálása közben: " + e.message); } }
        
        function saveSettings() {
            localStorage.setItem('userName', document.getElementById('userNameInput').value);
            localStorage.setItem('autoBackupFrequency', document.getElementById('autoBackupFrequency').value);
            showCustomAlert('Beállítások mentve!', 'success');
        }
        function loadSettings() {
            document.getElementById('userNameInput').value = localStorage.getItem('userName') || '';
            document.getElementById('autoBackupFrequency').value = localStorage.getItem('autoBackupFrequency') || 'never';
            document.getElementById('themeSelector').value = localStorage.getItem('theme') || 'auto';
        }
        function exportData() { if (records.length === 0) { showCustomAlert('Nincsenek adatok az exportáláshoz!', 'info'); return; } const dataStr = JSON.stringify(records, null, 2); const blob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a');
            a.href = url;
            a.download = `munkaido_backup_${new Date().toISOString().split("T")[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url); }
        function importData() { const fileInput = document.getElementById('importFile'); if (!fileInput.files.length) { showCustomAlert('Kérlek válassz egy fájlt!', 'info'); return; } if (!confirm('Biztosan importálod? A jelenlegi adatok felülíródnak!')) return; const reader = new FileReader();
            reader.onload = function(e) { try { const imported = JSON.parse(e.target.result); if (Array.isArray(imported)) { records = imported;
                        if(currentUser) {
                           migrateLocalToFirestore(records);
                        } else {
                           localStorage.setItem('workRecords', JSON.stringify(records));
                        }
                        renderApp();
                        showCustomAlert('Adatok sikeresen importálva!', 'success'); } else { throw new Error('Érvénytelen formátum.'); } } catch (err) { showCustomAlert('Hiba: ' + err.message, 'info'); } };
            reader.readAsText(fileInput.files[0]); }
        
        // --- Témaválasztó funkciók ---
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else if (theme === 'light') {
                document.documentElement.classList.remove('dark');
            } else {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }
        }
        function setTheme(theme) {
            applyTheme(theme);
            localStorage.setItem('theme', theme);
        }
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'auto';
            applyTheme(savedTheme);
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                if(localStorage.getItem('theme') === 'auto') {
                    applyTheme('auto');
                }
            });
        }

        // --- Automatikus kiegészítő funkciók ---
        function updateUniqueLocations() {
            const locations = new Set();
            (records || []).forEach(r => {
                if (r.startLocation) locations.add(r.startLocation);
                if (r.endLocation) locations.add(r.endLocation);
            });
            uniqueLocations = Array.from(locations).sort();
        }
        function initAutocomplete(input) {
            if (!input) return;
            input.addEventListener('input', function(e) {
                const val = this.value;
                hideAutocomplete();
                if (!val) return false;
                const suggestions = document.createElement('div');
                suggestions.setAttribute('id', 'autocomplete-list');
                suggestions.setAttribute('class', 'autocomplete-list absolute z-20 w-full border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto bg-white');
                suggestions.style.top = (this.offsetHeight + 12) + 'px';
                const filteredLocations = uniqueLocations.filter(loc => loc.toLowerCase().includes(val.toLowerCase()));
                filteredLocations.forEach(loc => {
                    const item = document.createElement('div');
                    item.innerHTML = loc.replace(new RegExp(val, 'gi'), '<strong>$&</strong>');
                    item.setAttribute('class', 'p-2 hover:bg-gray-100 cursor-pointer autocomplete-item');
                    item.addEventListener('click', function(e) {
                        input.value = loc;
                        hideAutocomplete();
                    });
                    suggestions.appendChild(item);
                });
                if(filteredLocations.length > 0) this.parentNode.appendChild(suggestions);
            });
        }
        function initAllAutocomplete() {
            initAutocomplete(document.getElementById('liveStartLocation'));
            initAutocomplete(document.getElementById('startLocation'));
            initAutocomplete(document.getElementById('endLocation'));
        }
        function hideAutocomplete() {
            const lists = document.querySelectorAll('#autocomplete-list');
            lists.forEach(list => list.parentNode.removeChild(list));
        }
        
        // --- Matematikai és segédfüggvények ---
        function calculateWorkMinutes(start, end) { if (!start || !end) return 0; const s = new Date(`2000-01-01T${start}`); let e = new Date(`2000-01-01T${end}`); if (e < s) e.setDate(e.getDate() + 1); return Math.floor((e - s) / 60000); }
        function calculateNightWorkMinutes(startTime, endTime) { if (!startTime || !endTime) return 0; const start = new Date(`1970-01-01T${startTime}`); let end = new Date(`1970-01-01T${endTime}`); if (end <= start) end.setDate(end.getDate() + 1); let nightMinutes = 0; let current = new Date(start); while (current < end) { const hour = current.getHours(); if (hour >= 20 || hour < 5) { nightMinutes++; }
                current.setMinutes(current.getMinutes() + 1); } return nightMinutes; }
        function parseTimeToMinutes(timeStr) { if (!timeStr || !timeStr.includes(':')) return 0; const p = timeStr.split(':'); if (p.length !== 2) return 0; return parseInt(p[0], 10) * 60 + parseInt(p[1], 10); }
        function formatDuration(minutes) { const h = Math.floor(minutes / 60); const m = minutes % 60; return `${h}ó ${m}p`; }
        function formatTimeInput(inputElement, allowHoursOver24 = false) { let value = inputElement.value.replace(/[^0-9]/g, ''); if (value.length < 3) return; if (value.length === 3 && !allowHoursOver24) value = '0' + value; const hours = parseInt(value.substring(0, value.length - 2), 10); const minutes = parseInt(value.substring(value.length - 2), 10); if (minutes >= 0 && minutes <= 59 && hours >= 0 && (allowHoursOver24 || hours <= 23)) { inputElement.value = `${String(hours).padStart(2,"0")}:${String(minutes).padStart(2,"0")}`; } else { inputElement.value = ''; }
            updateDisplays(); }

    </script>
</body>
</html>
